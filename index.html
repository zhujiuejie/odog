<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLayer NFT 铸造站 (静态)</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); text-align: center; max-width: 450px; width: 90%; }
        h1 { color: #1e3a8a; margin-bottom: 25px; font-size: 1.8em; }
        button { background-color: #3b82f6; color: white; border: none; padding: 12px 24px; margin: 8px 0; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background-color 0.3s, opacity 0.3s; width: 100%; font-weight: bold; }
        button:hover:not(:disabled) { background-color: #1d4ed8; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        .status { margin-top: 25px; padding: 15px; border-radius: 8px; font-size: 0.9em; text-align: left; line-height: 1.5; }
        .info { background-color: #e0f2fe; color: #075985; }
        .error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        input[type="text"] { width: 95%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        .data-display { text-align: left; margin-bottom: 20px; padding: 10px; background-color: #f9fafb; border-radius: 6px; }
        .data-display p { margin: 5px 0; font-size: 0.95em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>XLayer ODOG NFT 铸造站</h1>
        
        <button id="connectWalletBtn">连接钱包</button>
        
        <div id="mintArea" style="display: none;">
            <div class="data-display">
                <p>当前地址: <span id="currentAddress">--</span></p>
                <p>ODOG 余额: <span id="odogBalance">--</span></p>
                <p>授权额度: <span id="allowanceStatus">--</span></p>
                <p>网络: <span id="currentNetwork" style="font-weight: bold;">未连接</span></p>
            </div>

            <input type="text" id="messageInput" placeholder="请输入 NFT 消息/元数据">
            
            <button id="approveBtn" disabled>授权 100 ODOG 给合约</button>
            <button id="mintBtn" disabled>铸造 NFT (100 ODOG)</button>
        </div>
        
        <div class="status info" id="statusMessage">请连接您的 Web3 钱包 (例如 MetaMask)。</div>
    </div>

    <script>
        // --- 合约和区块链配置 ---
        const XLAYER_CHAIN_ID = 196;
        const NFT_CONTRACT_ADDRESS = '0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917';
        const ODOG_CONTRACT_ADDRESS = '0xc3f431cd1b7220cca703ee08c24ca645a71e72c8';
        // 100 个代币 (假设 18 位小数)
        const MINT_AMOUNT = ethers.utils.parseUnits('100', 18); 
        
        // NFT 合约 ABI (只需 writeMessage)
        const NFT_ABI = [
            {"constant":false,"inputs":[{"internalType":"string","name":"message","type":"string"}],"name":"writeMessage","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        // ODOG 代币合约 ABI (只需 balanceOf, approve, allowance)
        const ODOG_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
        ];

        // --- Ethers 变量 ---
        let provider;
        let signer;
        let userAddress;
        let odogContract;
        let nftContract;

        // --- DOM 元素 ---
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const mintArea = document.getElementById('mintArea');
        const statusMessage = document.getElementById('statusMessage');
        const odogBalanceSpan = document.getElementById('odogBalance');
        const allowanceStatusSpan = document.getElementById('allowanceStatus');
        const approveBtn = document.getElementById('approveBtn');
        const mintBtn = document.getElementById('mintBtn');
        const currentNetworkSpan = document.getElementById('currentNetwork');
        const messageInput = document.getElementById('messageInput');
        const currentAddressSpan = document.getElementById('currentAddress');


        // --- 核心函数 ---

        /**
         * @dev 更新状态信息
         */
        function updateStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
        }
        
        /**
         * @dev 启用/禁用按钮
         */
        function setButtonsState(approveDisabled, mintDisabled) {
            approveBtn.disabled = approveDisabled;
            mintBtn.disabled = mintDisabled;
        }

        /**
         * @dev 连接 Web3 钱包
         */
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                updateStatus('未检测到 Web3 钱包 (例如 MetaMask)。请安装并刷新页面。', 'error');
                return;
            }

            try {
                // 请求连接钱包
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // 检查网络
                const { chainId } = await provider.getNetwork();
                
                if (chainId !== XLAYER_CHAIN_ID) {
                    currentNetworkSpan.textContent = `❌ 错误网络 (ID: ${chainId})`;
                    updateStatus('请将您的钱包切换到 XLayer 区块链。', 'error');
                    mintArea.style.display = 'block';
                    connectWalletBtn.style.display = 'none';
                    setButtonsState(true, true);
                    return;
                }

                currentNetworkSpan.textContent = `✅ XLayer (ID: ${XLAYER_CHAIN_ID})`;
                currentAddressSpan.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                updateStatus('钱包连接成功！正在检查状态...', 'info');
                
                // 初始化合约
                odogContract = new ethers.Contract(ODOG_CONTRACT_ADDRESS, ODOG_ABI, signer);
                nftContract = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_ABI, signer);

                connectWalletBtn.style.display = 'none';
                mintArea.style.display = 'block';

                await checkAndSetState();

            } catch (error) {
                console.error(error);
                updateStatus(`连接钱包失败: ${error.message || error}`, 'error');
            }
        }

        /**
         * @dev 检查 ODOG 余额和授权状态
         */
        async function checkAndSetState() {
            try {
                setButtonsState(true, true); // 检查时禁用按钮

                // 1. 检查余额
                const balance = await odogContract.balanceOf(userAddress);
                const odogBalanceFormatted = ethers.utils.formatUnits(balance, 18);
                odogBalanceSpan.textContent = odogBalanceFormatted;

                const hasEnoughBalance = balance.gte(MINT_AMOUNT);

                if (!hasEnoughBalance) {
                    odogBalanceSpan.style.color = 'red';
                    updateStatus(`您的 ODOG 余额 (${odogBalanceFormatted}) 不足 100 ODOG。`, 'error');
                    return;
                } else {
                    odogBalanceSpan.style.color = '#065f46';
                }

                // 2. 检查授权
                const allowance = await odogContract.allowance(userAddress, NFT_CONTRACT_ADDRESS);
                const isApproved = allowance.gte(MINT_AMOUNT);
                const allowanceFormatted = ethers.utils.formatUnits(allowance, 18);

                allowanceStatusSpan.textContent = `${allowanceFormatted} ODOG`;

                if (isApproved) {
                    allowanceStatusSpan.style.color = '#065f46';
                    setButtonsState(true, false); // 禁用授权，启用铸造
                    updateStatus('✅ 余额充足，已授权！请设置消息并铸造 NFT。', 'success');
                } else {
                    allowanceStatusSpan.style.color = '#ca8a04'; // Orange
                    setButtonsState(false, true); // 启用授权，禁用铸造
                    updateStatus('余额充足，但需要先授权 NFT 合约花费 100 ODOG。', 'info');
                }

            } catch (error) {
                console.error(error);
                updateStatus(`状态检查失败: ${error.message || error}`, 'error');
            }
        }

        /**
         * @dev 授权 ODOG 代币
         */
        async function approveODOG() {
            setButtonsState(true, true);
            
            try {
                updateStatus('正在请求授权交易... 请在钱包中确认。', 'info');
                const tx = await odogContract.approve(NFT_CONTRACT_ADDRESS, MINT_AMOUNT);
                
                updateStatus(`授权交易已发送 (${tx.hash.slice(0, 10)}...)，请等待确认...`, 'info');
                
                await tx.wait(); // 等待交易确认
                
                updateStatus('✅ ODOG 授权成功！正在更新状态...', 'success');
                await checkAndSetState(); // 重新检查状态

            } catch (error) {
                console.error(error);
                updateStatus(`授权失败: ${error.message || '用户拒绝或交易失败'}`, 'error');
                // 恢复按钮状态，以便用户重试
                if (await odogContract.allowance(userAddress, NFT_CONTRACT_ADDRESS) < MINT_AMOUNT) {
                    setButtonsState(false, true); 
                }
            }
        }

        /**
         * @dev 铸造 NFT
         */
        async function mintNFT() {
            const message = messageInput.value.trim();
            if (!message) {
                updateStatus('请输入您的 NFT 消息/元数据。', 'error');
                return;
            }
            
            setButtonsState(true, true); // 铸造时禁用所有按钮
            
            try {
                updateStatus('正在请求铸造交易... 请在钱包中确认。', 'info');

                // 调用 NFT 合约的 writeMessage 函数
                const tx = await nftContract.writeMessage(message);

                updateStatus(`铸造交易已发送 (${tx.hash.slice(0, 10)}...)，请等待确认...`, 'info');
                
                await tx.wait(); // 等待交易确认
                
                updateStatus(`🎉 NFT 铸造成功! 交易哈希: ${tx.hash.slice(0, 10)}...`, 'success');
                
                await checkAndSetState(); // 重新检查状态和余额

            } catch (error) {
                console.error(error);
                updateStatus(`铸造失败: ${error.message || '用户拒绝或交易失败'}`, 'error');
                // 恢复按钮状态
                await checkAndSetState(); 
            }
        }

        // --- 事件监听器 ---
        connectWalletBtn.addEventListener('click', connectWallet);
        approveBtn.addEventListener('click', approveODOG);
        mintBtn.addEventListener('click', mintNFT);

        // 处理网络/账户变化事件
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                // 推荐重新加载页面以确保 Ethers.js 状态完全重置
                window.location.reload(); 
            });
            window.ethereum.on('accountsChanged', (accounts) => {
                // 如果账户列表为空，也重新加载
                if (accounts.length === 0) {
                    window.location.reload();
                } else {
                    connectWallet(); // 尝试重新连接以更新地址
                }
            });
        }
    </script>
</body>
</html>
