<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLayer NFT é“¸é€ ç«™</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); text-align: center; max-width: 400px; width: 90%; }
        h1 { color: #333; margin-bottom: 20px; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 24px; margin: 10px 0; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; width: 100%; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .status { margin-top: 20px; padding: 15px; border-radius: 8px; background-color: #e9ecef; color: #333; text-align: left; }
        .error { color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .success { color: #28a745; background-color: #d4edda; border: 1px solid #c3e6cb; }
        input[type="text"] { width: 90%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="container">
        <h1>XLayer NFT é“¸é€ ç«™ (100 ODOG é”€æ¯)</h1>
        <button id="connectWalletBtn">è¿æ¥é’±åŒ…</button>
        <div id="mintArea" style="display: none;">
            <p>**å½“å‰ç½‘ç»œ:** <span id="currentNetwork">æœªè¿æ¥</span></p>
            <p>ODOG ä½™é¢: <span id="odogBalance">--</span></p>
            <p>æˆæƒçŠ¶æ€: <span id="allowanceStatus">--</span></p>
            <input type="text" id="messageInput" placeholder="è¯·è¾“å…¥NFTæ¶ˆæ¯/å…ƒæ•°æ® (ä¾‹å¦‚: Hello World)">
            <button id="approveBtn" disabled>æˆæƒ 100 ODOG ç»™åˆçº¦</button>
            <button id="mintBtn" disabled>é“¸é€  NFT</button>
        </div>
        <div class="status" id="statusMessage">è¯·è¿æ¥æ‚¨çš„ Web3 é’±åŒ… (ä¾‹å¦‚ MetaMask)ã€‚</div>
    </div>

    <script>
        // --- åˆçº¦å’ŒåŒºå—é“¾é…ç½® ---
        const XLAYER_CHAIN_ID = 196;
        const NFT_CONTRACT_ADDRESS = '0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917';
        const ODOG_CONTRACT_ADDRESS = '0xc3f431cd1b7220cca703ee08c24ca645a71e72c8';
        const MINT_AMOUNT = ethers.utils.parseUnits('100', 18); // å‡è®¾ ODOG æ˜¯ 18 ä½å°æ•°
        
        // ä½ çš„ NFT åˆçº¦ ABI (å·²ç®€åŒ–ï¼Œä»…ä¿ç•™å¿…è¦çš„å‡½æ•°ï¼Œä½ å¯ä»¥ä½¿ç”¨å®Œæ•´çš„ ABI)
        const NFT_ABI = [{"constant":false,"inputs":[{"internalType":"string","name":"message","type":"string"}],"name":"writeMessage","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}, {"constant":false,"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}, {"constant":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","payable":false,"type":"event"}, {"constant":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","payable":false,"type":"event"}, {"constant":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","payable":false,"type":"event"}, {"constant":false,"inputs":[],"name":"ODOG_TOKEN","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}, {"constant":false,"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getMessage","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}, {"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}, {"constant":false,"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}, {"constant":false,"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"pure","type":"function"}, {"constant":false,"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}, {"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}];

        // ODOG ä»£å¸åˆçº¦ ABI (åªéœ€ balanceOf, approve, allowance)
        const ODOG_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            // å‡è®¾ ODOG ä»£å¸æ˜¯ 18 ä½å°æ•°
            "uint8 decimals()"
        ];

        // --- Ethers å˜é‡ ---
        let provider;
        let signer;
        let userAddress;
        let odogContract;
        let nftContract;

        // --- DOM å…ƒç´  ---
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const mintArea = document.getElementById('mintArea');
        const statusMessage = document.getElementById('statusMessage');
        const odogBalanceSpan = document.getElementById('odogBalance');
        const allowanceStatusSpan = document.getElementById('allowanceStatus');
        const approveBtn = document.getElementById('approveBtn');
        const mintBtn = document.getElementById('mintBtn');
        const currentNetworkSpan = document.getElementById('currentNetwork');
        const messageInput = document.getElementById('messageInput');


        // --- æ ¸å¿ƒå‡½æ•° ---

        /**
         * @dev æ›´æ–°çŠ¶æ€ä¿¡æ¯
         * @param message æ¶ˆæ¯å†…å®¹
         * @param type æ¶ˆæ¯ç±»å‹: 'info', 'success', 'error'
         */
        function updateStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
        }

        /**
         * @dev è¿æ¥ Web3 é’±åŒ… (MetaMask)
         */
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                updateStatus('æœªæ£€æµ‹åˆ° Web3 é’±åŒ… (ä¾‹å¦‚ MetaMask)ã€‚è¯·å®‰è£…å¹¶åˆ·æ–°é¡µé¢ã€‚', 'error');
                return;
            }

            try {
                // è¯·æ±‚è¿æ¥é’±åŒ…
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // æ£€æŸ¥ç½‘ç»œ
                const { chainId } = await provider.getNetwork();
                if (chainId !== XLAYER_CHAIN_ID) {
                    currentNetworkSpan.textContent = `âŒ é”™è¯¯ç½‘ç»œ (ID: ${chainId})ï¼Œè¯·åˆ‡æ¢åˆ° XLayer (ID: ${XLAYER_CHAIN_ID})`;
                    updateStatus('è¯·å°†æ‚¨çš„é’±åŒ…åˆ‡æ¢åˆ° XLayer åŒºå—é“¾ã€‚', 'error');
                    mintArea.style.display = 'block';
                    connectWalletBtn.style.display = 'none';
                    return;
                }

                currentNetworkSpan.textContent = `âœ… XLayer (åœ°å€: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)})`;
                updateStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼æ­£åœ¨æ£€æŸ¥ä½™é¢å’Œæˆæƒ...', 'info');
                
                // åˆå§‹åŒ–åˆçº¦
                odogContract = new ethers.Contract(ODOG_CONTRACT_ADDRESS, ODOG_ABI, signer);
                nftContract = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_ABI, signer);

                connectWalletBtn.style.display = 'none';
                mintArea.style.display = 'block';

                await checkAndSetState();

            } catch (error) {
                console.error(error);
                updateStatus(`è¿æ¥é’±åŒ…å¤±è´¥: ${error.message || error}`, 'error');
            }
        }

        /**
         * @dev æ£€æŸ¥ ODOG ä½™é¢å’Œå¯¹ NFT åˆçº¦çš„æˆæƒçŠ¶æ€
         */
        async function checkAndSetState() {
            try {
                // 1. æ£€æŸ¥ä½™é¢
                const balance = await odogContract.balanceOf(userAddress);
                const odogBalanceFormatted = ethers.utils.formatUnits(balance, 18);
                odogBalanceSpan.textContent = odogBalanceFormatted;

                const hasEnoughBalance = balance.gte(MINT_AMOUNT);

                if (!hasEnoughBalance) {
                    odogBalanceSpan.style.color = 'red';
                    updateStatus(`æ‚¨çš„ ODOG ä½™é¢ (${odogBalanceFormatted}) ä¸è¶³ 100 ODOGã€‚`, 'error');
                    approveBtn.disabled = true;
                    mintBtn.disabled = true;
                    return;
                } else {
                    odogBalanceSpan.style.color = 'green';
                }

                // 2. æ£€æŸ¥æˆæƒ
                const allowance = await odogContract.allowance(userAddress, NFT_CONTRACT_ADDRESS);
                const isApproved = allowance.gte(MINT_AMOUNT);
                const allowanceFormatted = ethers.utils.formatUnits(allowance, 18);

                allowanceStatusSpan.textContent = `${allowanceFormatted} ODOG`;

                if (isApproved) {
                    allowanceStatusSpan.style.color = 'green';
                    approveBtn.disabled = true;
                    mintBtn.disabled = false;
                    updateStatus('ä½™é¢å……è¶³ï¼Œä¸”å·²æˆæƒï¼æ‚¨ç°åœ¨å¯ä»¥é“¸é€  NFTã€‚', 'success');
                } else {
                    allowanceStatusSpan.style.color = 'orange';
                    approveBtn.disabled = false;
                    mintBtn.disabled = true;
                    updateStatus('ä½™é¢å……è¶³ï¼Œä½†éœ€è¦å…ˆæˆæƒ NFT åˆçº¦èŠ±è´¹æ‚¨çš„ ODOGã€‚', 'info');
                }

            } catch (error) {
                console.error(error);
                updateStatus(`çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message || error}`, 'error');
                approveBtn.disabled = true;
                mintBtn.disabled = true;
            }
        }

        /**
         * @dev æˆæƒ ODOG ä»£å¸
         */
        async function approveODOG() {
            try {
                approveBtn.disabled = true;
                updateStatus('æ­£åœ¨è¯·æ±‚æˆæƒäº¤æ˜“... è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ã€‚', 'info');

                // æˆæƒç»™ NFT åˆçº¦èŠ±è´¹ MINT_AMOUNT æ•°é‡çš„ ODOG
                const tx = await odogContract.approve(NFT_CONTRACT_ADDRESS, MINT_AMOUNT);
                
                updateStatus(`æˆæƒäº¤æ˜“å·²å‘é€ (${tx.hash.slice(0, 10)}...)ï¼Œè¯·ç­‰å¾…ç¡®è®¤...`, 'info');
                
                await tx.wait(); // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                
                updateStatus('âœ… ODOG æˆæƒæˆåŠŸï¼æ‚¨ç°åœ¨å¯ä»¥é“¸é€  NFTã€‚', 'success');
                await checkAndSetState(); // é‡æ–°æ£€æŸ¥çŠ¶æ€

            } catch (error) {
                console.error(error);
                updateStatus(`æˆæƒå¤±è´¥: ${error.message || 'ç”¨æˆ·æ‹’ç»æˆ–äº¤æ˜“å¤±è´¥'}`, 'error');
                approveBtn.disabled = false;
            }
        }

        /**
         * @dev é“¸é€  NFT
         */
        async function mintNFT() {
            const message = messageInput.value.trim();
            if (!message) {
                updateStatus('è¯·è¾“å…¥æ‚¨çš„ NFT æ¶ˆæ¯/å…ƒæ•°æ®ã€‚', 'error');
                return;
            }
            
            try {
                mintBtn.disabled = true;
                updateStatus('æ­£åœ¨è¯·æ±‚é“¸é€ äº¤æ˜“... è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ã€‚', 'info');

                // è°ƒç”¨ NFT åˆçº¦çš„ writeMessage å‡½æ•°ï¼ˆå‡è®¾è¿™æ˜¯é“¸é€ å‡½æ•°ï¼‰
                const tx = await nftContract.writeMessage(message);

                updateStatus(`é“¸é€ äº¤æ˜“å·²å‘é€ (${tx.hash.slice(0, 10)}...)ï¼Œè¯·ç­‰å¾…ç¡®è®¤...`, 'info');
                
                await tx.wait(); // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                
                updateStatus(`ğŸ‰ NFT é“¸é€ æˆåŠŸ! äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`, 'success');
                
                // é‡æ–°æ£€æŸ¥çŠ¶æ€å’Œä½™é¢
                await checkAndSetState();

            } catch (error) {
                console.error(error);
                updateStatus(`é“¸é€ å¤±è´¥: ${error.message || 'ç”¨æˆ·æ‹’ç»æˆ–äº¤æ˜“å¤±è´¥'}`, 'error');
                mintBtn.disabled = false;
            }
        }

        // --- äº‹ä»¶ç›‘å¬å™¨ ---
        connectWalletBtn.addEventListener('click', connectWallet);
        approveBtn.addEventListener('click', approveODOG);
        mintBtn.addEventListener('click', mintNFT);

        // å¤„ç†ç½‘ç»œ/è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                // å½“ç½‘ç»œåˆ‡æ¢æ—¶ï¼Œåˆ·æ–°é¡µé¢æˆ–é‡æ–°è¿æ¥
                window.location.reload(); 
            });
            window.ethereum.on('accountsChanged', (accounts) => {
                // å½“è´¦æˆ·åˆ‡æ¢æ—¶ï¼Œé‡æ–°è¿æ¥
                if (accounts.length > 0) {
                    connectWallet(); 
                } else {
                    window.location.reload(); 
                }
            });
        }
    </script>
</body>
</html>
