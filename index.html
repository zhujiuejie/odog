<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Odog NFT 铸造</title>
<script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
<style>
body{font-family:sans-serif;background:#0d1117;color:#c9d1d9;margin:0;padding:20px;display:flex;justify-content:center}
.container{width:100%;max-width:600px;background:#161b22;border-radius:12px;padding:20px;border:1px solid #30363d;box-shadow:0 10px 30px rgba(2,6,23,0.7)}
h1{color:#58a6ff;text-align:center}
textarea{width:100%;min-height:120px;padding:12px;border-radius:8px;border:1px solid #30363d;background:#0d1117;color:#c9d1d9;resize:none;margin-top:10px}
button{margin-top:10px;width:100%;padding:12px;border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer}
.btn-connect{background:#38a169} .btn-mint{background:#4299e1}
.status{margin-top:12px;padding:10px;border-radius:8px;background:#222;border:1px solid #30363d;text-align:center}
.note{margin-top:10px;color:#fc8181;font-weight:700;text-align:center}
</style>
</head>
<body>
<div class="container">
  <h1>Odog 链上留言 NFT</h1>
  <div id="wallet-status" class="status">钱包未连接</div>
  <button id="connect-btn" class="btn-connect">连接钱包</button>

  <label style="margin-top:10px">留言（会刻在 NFT 上，<=500 字节）</label>
  <textarea id="message"></textarea>

  <button id="mint-btn" class="btn-mint" disabled>铸造 NFT（消耗 100 ODOG）</button>
  <div class="note">注意：铸造将消耗并永久销毁 100 ODOG</div>
  <div id="tx-status" class="status" style="margin-top:10px"></div>
</div>

<script>
const NFT_ADDRESS = "0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917";
const ODOG_ADDRESS = "0xc3f431cd1b7220cca703ee08c24ca645a71e72c8";
const CHAIN_ID_DEC = 196;
const CHAIN_ID_HEX = "0xc4";
const ODOG_AMOUNT = ethers.utils.parseUnits("100",18);

const NFT_ABI = [{"constant":false,"inputs":[{"internalType":"string","name":"message","type":"string"}],"name":"writeMessage","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}];
const ERC20_ABI = [{"constant":true,"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

let provider=null, signer=null, nftContract=null, odogContract=null, currentAccount=null;

async function connectWallet(){
  if(!window.ethereum){ alert("未检测到钱包，请安装MetaMask或OKX钱包"); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  signer = provider.getSigner();
  try{
    const accs = await window.ethereum.request({ method:"eth_requestAccounts" });
    if(!accs || accs.length===0){ alert("未获取到账户"); return; }
    currentAccount = accs[0];
    document.getElementById("wallet-status").textContent = "已连接: "+currentAccount.slice(0,8)+"..."+currentAccount.slice(-6);

    nftContract = new ethers.Contract(NFT_ADDRESS,NFT_ABI,signer);
    odogContract = new ethers.Contract(ODOG_ADDRESS,ERC20_ABI,signer);

    const net = await provider.getNetwork();
    if(net.chainId!==CHAIN_ID_DEC){
      try{ await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:CHAIN_ID_HEX}] }); } catch(e){ alert("请切换到 X Layer 网络 (ChainID 196)"); }
    }

    document.getElementById("mint-btn").disabled = false;
  }catch(e){ console.error(e); alert("连接失败: "+(e.message||e)); }
}

async function mintNFT(){
  const msg = document.getElementById("message").value.trim();
  if(!msg){ alert("留言不能为空"); return; }
  const bytes = ethers.utils.toUtf8Bytes(msg);
  if(bytes.length>500){ alert("留言过长，限制 500 字节"); return; }

  try{
    document.getElementById("tx-status").textContent = "发送交易中...";
    const tx = await nftContract.writeMessage(msg);
    document.getElementById("tx-status").textContent = "交易已发送: "+tx.hash;
    await tx.wait();
    document.getElementById("tx-status").textContent = "✅ 铸造成功！交易哈希: "+tx.hash;
  }catch(e){ console.error(e); document.getElementById("tx-status").textContent = "铸造失败: "+(e.message||e); }
}

document.getElementById("connect-btn").addEventListener("click", connectWallet);
document.getElementById("mint-btn").addEventListener("click", mintNFT);
</script>
</body>
</html>
