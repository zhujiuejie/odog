<script>
  console.log('[Debug] 脚本开始加载...');

  // 配置
  const NFT_ADDR = '0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917';
  const ODOG_ADDR = '0xc3f431cd1b7220cca703ee08c24ca645a71e72c8';
  const CHAIN_ID = 196;
  const ODOG_AMT = ethers ? ethers.utils.parseUnits('100', 18) : null;

  // ABI (简化版)
  const ERC20_ABI = [
    'function allowance(address owner, address spender) view returns (uint256)',
    'function approve(address spender, uint256 amount) returns (bool)'
  ];
  const NFT_ABI = [
    'function writeMessage(string message)'
  ];

  let provider, signer, odog, nft, account;

  function updateStatus(msg, type = 'info') {
    const el = document.getElementById('status');
    if (el) {
      el.textContent = msg;
      el.className = type;
    }
    console.log(`[Status ${type.toUpperCase()}]: ${msg}`);
  }

  // 检查 ethers
  if (typeof ethers === 'undefined') {
    updateStatus('ethers.js 加载失败！请刷新或检查网络。', 'error');
    console.error('[Error] ethers 未加载');
  } else {
    console.log('[Debug] ethers 加载成功');
  }

  // 绑定事件 - 用 setTimeout 确保 DOM 就绪
  function bindEvents() {
    console.log('[Debug] 开始绑定事件');

    // 测试按钮
    const testBtn = document.getElementById('test-btn');
    if (testBtn) {
      testBtn.addEventListener('click', () => {
        console.log('[Debug] 测试按钮被点击！一切正常，继续连接钱包。');
        alert('按钮响应正常！检查控制台日志。');
      });
      console.log('[Debug] 测试按钮绑定成功');
    }

    // 连接按钮
    const connectBtn = document.getElementById('connect');
    if (connectBtn) {
      connectBtn.addEventListener('click', connectWallet);
      console.log('[Debug] 连接按钮绑定成功');
    } else {
      console.error('[Error] 找不到连接按钮！');
    }

    // 授权按钮
    const approveBtn = document.getElementById('approve');
    if (approveBtn) {
      approveBtn.addEventListener('click', approveODOG);
      console.log('[Debug] 授权按钮绑定成功');
    }

    // 铸造按钮
    const mintBtn = document.getElementById('mint');
    if (mintBtn) {
      mintBtn.addEventListener('click', mintNFT);
      console.log('[Debug] 铸造按钮绑定成功');
    }
  }

  // DOM 就绪 + 延迟绑定
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(bindEvents, 100);
    });
  } else {
    setTimeout(bindEvents, 100);
  }

  async function connectWallet() {
    console.log('[Debug] 连接钱包被点击！');
    const btn = document.getElementById('connect');
    btn.disabled = true;
    btn.textContent = '连接中...';
    try {
      if (!window.ethereum) {
        throw new Error('未检测到钱包！安装 MetaMask/OKX');
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      const accounts = await provider.send('eth_requestAccounts', []);
      signer = provider.getSigner();
      account = await signer.getAddress();
      updateStatus(`连接成功: ${account.slice(0,6)}...${account.slice(-4)}`, 'success');
      btn.textContent = '已连接';

      const net = await provider.getNetwork();
      if (net.chainId !== CHAIN_ID) {
        throw new Error(`请切换到 Chain ID ${CHAIN_ID}`);
      }

      odog = new ethers.Contract(ODOG_ADDR, ERC20_ABI, signer);
      nft = new ethers.Contract(NFT_ADDR, NFT_ABI, signer);
      await checkApproval(); // 连接后立即检查授权
    } catch (err) {
      console.error('[Connect Error]', err);
      updateStatus('连接失败: ' + err.message, 'error');
      btn.disabled = false;
      btn.textContent = '连接钱包';
    }
  }

  async function checkApproval() {
    console.log('[Debug] 检查授权状态...');
    if (!odog || !account) {
      updateStatus('合约或账户未初始化', 'error');
      return;
    }
    try {
      const allow = await odog.allowance(account, NFT_ADDR);
      console.log('[Debug] 当前授权额度:', allow.toString());
      if (allow.lt(ODOG_AMT)) {
        updateStatus('需要授权 100 ODOG', 'info');
        document.getElementById('approve').disabled = false;
        document.getElementById('mint').disabled = true;
      } else {
        updateStatus('已授权，可铸造', 'success');
        document.getElementById('approve').disabled = true;
        document.getElementById('mint').disabled = false;
      }
    } catch (err) {
      console.error('[Check Approval Error]', err);
      updateStatus('检查授权失败: ' + err.message, 'error');
      document.getElementById('approve').disabled = true; // 出错时禁用
    }
  }

  async function approveODOG() {
    console.log('[Debug] 授权被点击！');
    const btn = document.getElementById('approve');
    btn.disabled = true;
    btn.textContent = '授权中...';
    try {
      const tx = await odog.approve(NFT_ADDR, ethers.constants.MaxUint256);
      updateStatus('授权交易发送中...', 'info');
      await tx.wait();
      updateStatus('授权成功！', 'success');
      await checkApproval();
    } catch (err) {
      console.error('[Approve Error]', err);
      updateStatus('授权失败: ' + err.message, 'error');
      btn.disabled = false;
      btn.textContent = '授权 100 ODOG';
    }
  }

  async function mintNFT() {
    console.log('[Debug] 铸造被点击！');
    const msg = document.getElementById('message').value.trim();
    if (!msg) return updateStatus('留言不能为空', 'error');
    if (ethers.utils.toUtf8Bytes(msg).length > 500) return updateStatus('留言超 500 字节', 'error');
    if (!confirm('确认铸造？销毁 100 ODOG，不可逆！')) return;

    const btn = document.getElementById('mint');
    btn.disabled = true;
    btn.textContent = '铸造中...';
    try {
      const tx = await nft.writeMessage(msg);
      await tx.wait();
      updateStatus(`成功！Tx: ${tx.hash.slice(0,10)}...`, 'success');
      document.getElementById('message').value = '';
      btn.disabled = true;
    } catch (err) {
      console.error('[Mint Error]', err);
      updateStatus('铸造失败: ' + err.message, 'error');
      btn.disabled = false;
      btn.textContent = '铸造 NFT';
    }
  }

  console.log('[Debug] 脚本加载结束');
</script>
