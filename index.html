<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odog 极简铸造终端</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        /* 极简主义 CSS */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f9; /* 浅色背景 */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        h2 {
            text-align: center;
            color: #007bff; /* 蓝色主色调 */
            margin-bottom: 25px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
            resize: none;
        }
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 连接和铸造/授权各占一半 */
            gap: 15px;
        }
        button {
            padding: 12px;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #connect-button {
            background-color: #28a745; /* 绿色连接 */
        }
        #approve-button {
            background-color: #ffc107; /* 黄色授权 */
            color: #333;
        }
        #mint-button {
            background-color: #007bff; /* 蓝色铸造 */
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.8;
            color: #666;
        }
        .info-panel {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.5;
            text-align: center;
            color: #555;
            background-color: #e9ecef;
        }
        #status-message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .info {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>X Layer 留言 NFT 铸造</h2>
    
    <textarea id="message-input" placeholder="输入你想永久记录的留言... (500字节限制)"></textarea>
    
    <div class="button-group">
        <button id="connect-button" onclick="connectWallet()">连接钱包</button>
        <button id="approve-button" onclick="approveODOG()" disabled style="display:none">授权 (1)</button>
        <button id="mint-button" onclick="mintMessage()" disabled style="display:none">铸造 (2)</button>
    </div>
    
    <div id="status-message"></div>
    
    <div class="info-panel">
        链：**X Layer (196)** | 费用：**100 ODOG (永久销毁)**
        <br>
        <span style="font-size:0.8em;">合约地址: 0x8ed8...7917</span>
    </div>
</div>

<script>
    // =================================================================
    // 1. 配置信息
    // =================================================================
    const CONTRACT_ADDRESS = "0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917";
    const CHAIN_ID_DECIMAL = 196; 
    const ODOG_TOKEN_ADDRESS = "0xc3F431Cd1B7220cCa703Ee08C24ca645A71e72c8";
    const ODOG_AMOUNT = ethers.utils.parseUnits("100", 18); 
    
    // ABI 简化
    const ERC20_ABI = [{ "constant": false, "inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "approve", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "address", "name": "spender", "type": "address"}], "name": "allowance", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{"internalType": "address", "name": "owner", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function" }];
    
    const CONTRACT_ABI = [{"constant":false,"inputs":[{"internalType":"string","name":"message","type":"string"}],"name":"writeMessage","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"ODOG_TOKEN","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}, /* ... 省略不必要的只读 ABI 以保持简洁 ... */]; 

    // =================================================================
    // 2. 状态和 UI 元素
    // =================================================================
    const statusDiv = document.getElementById('status-message');
    const connectButton = document.getElementById('connect-button');
    const approveButton = document.getElementById('approve-button');
    const mintButton = document.getElementById('mint-button');
    
    let provider;
    let signer;
    let contract;
    let odogContract;
    let currentAccount = null;

    // =================================================================
    // 3. 核心工具函数
    // =================================================================

    function setStatus(message, isError = false, isInfo = false) {
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        statusDiv.className = isError ? 'error' : (isInfo ? 'info' : 'success');
    }

    function toggleButtons(connected) {
        if (connected) {
            connectButton.style.display = 'none';
            approveButton.style.display = 'block';
            mintButton.style.display = 'block';
        } else {
            connectButton.style.display = 'block';
            approveButton.style.display = 'none';
            mintButton.style.display = 'none';
            connectButton.disabled = false;
            connectButton.textContent = "连接钱包";
        }
    }

    async function updateUIState() {
        if (!signer || !currentAccount) return;
        
        try {
            const { chainId } = await provider.getNetwork();

            if (chainId !== CHAIN_ID_DECIMAL) {
                setStatus(`⚠️ 网络错误！请切换到 X Layer (Chain ID ${CHAIN_ID_DECIMAL})。`, true);
                approveButton.disabled = true;
                mintButton.disabled = true;
                return;
            }

            // 检查余额
            const balance = await odogContract.balanceOf(currentAccount);
            if (balance.lt(ODOG_AMOUNT)) {
                 setStatus(`ODOG 余额不足！铸造需要 100 ODOG。`, true);
                 approveButton.disabled = true;
                 mintButton.disabled = true;
                 return;
            }

            // 检查授权
            const allowance = await odogContract.allowance(currentAccount, CONTRACT_ADDRESS);
            
            if (allowance.gte(ODOG_AMOUNT)) {
                approveButton.disabled = true;
                approveButton.textContent = "✅ 已授权";
                mintButton.disabled = false;
                mintButton.textContent = "铸造 NFT (100 ODOG 销毁)";
                setStatus("已连接 X Layer。请授权后铸造。", false, true);
            } else {
                approveButton.disabled = false;
                approveButton.textContent = "授权 ODOG (第一步)";
                mintButton.disabled = true;
                setStatus("请先授权合约使用 ODOG 代币。", false, true);
            }

        } catch(e) {
             console.error("更新 UI 状态失败:", e);
             setStatus("加载状态失败，请检查控制台。", true);
        }
    }

    // =================================================================
    // 4. 核心功能函数
    // =================================================================

    /**
     * 兼容性最高的连接钱包函数
     */
    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') {
            setStatus("❌ 未检测到 Web3 钱包。", true);
            return;
        }

        connectButton.disabled = true;
        connectButton.textContent = "连接中...";
        setStatus("正在请求钱包授权...", false, true);

        // **兼容性优化：延迟执行，确保钱包注入完全**
        await new Promise(resolve => setTimeout(resolve, 50)); 

        try {
            // **核心：使用原生 API 请求账户**
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            currentAccount = accounts[0];

            // 实例化 Ethers.js 对象
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            odogContract = new ethers.Contract(ODOG_TOKEN_ADDRESS, ERC20_ABI, signer);

            toggleButtons(true);
            await updateUIState();
            
        } catch (error) {
             console.error("连接钱包失败:", error);
             let errorMessage = error.code === 4001 ? "用户拒绝了连接请求。" : "连接失败，请重试。";
             
             setStatus(errorMessage, true);
             toggleButtons(false); 
        }
    }

    /**
     * 授权 ODOG 代币
     */
    async function approveODOG() {
        if (!signer) return;

        approveButton.disabled = true;
        approveButton.textContent = "等待确认...";
        setStatus(`正在授权合约使用 ODOG...`, false, true);

        try {
            // 授权 MaxUint256，避免重复授权
            const tx = await odogContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
            
            approveButton.textContent = "交易发送成功，等待确认...";
            await tx.wait(); 

            setStatus(`✅ 授权成功！现在可以铸造 NFT 了。`, false);
        } catch (error) {
            console.error(error);
            let errorMessage = error.code === 4001 ? "授权交易被用户拒绝。" : "授权交易失败！";
            setStatus(errorMessage, true);
        } finally {
            await updateUIState();
        }
    }

    /**
     * 铸造消息 NFT
     */
    async function mintMessage() {
        if (!signer || mintButton.disabled) return;

        const message = document.getElementById('message-input').value.trim();
        const messageBytes = ethers.utils.toUtf8Bytes(message);

        if (messageBytes.length === 0) {
            setStatus("留言内容不能为空。", true);
            return;
        }
        if (messageBytes.length > 500) {
            setStatus(`留言内容 (${messageBytes.length} 字节) 超过 500 字节限制。`, true);
            return;
        }

        mintButton.disabled = true;
        mintButton.textContent = "正在铸造... (请检查钱包)";
        setStatus("请在您的钱包中确认铸造交易... (100 ODOG 将被销毁)", false, true);

        try {
            // 调用 writeMessage
            const tx = await contract.writeMessage(message);
            
            mintButton.textContent = "交易发送成功，等待确认...";
            const receipt = await tx.wait(); 

            setStatus(`✅ 铸造成功！交易哈希: ${receipt.transactionHash}.`, false);
            document.getElementById('message-input').value = '';

        } catch (error) {
            console.error(error);
            let errorMessage = error.code === 4001 ? "铸造交易被用户拒绝。" : "铸造失败！请检查 ODOG 余额或交易详情。";
            setStatus(errorMessage, true);
        } finally {
            mintButton.disabled = false;
            mintButton.textContent = "铸造 NFT (100 ODOG 销毁)";
        }
    }

    // =================================================================
    // 5. 初始加载和监听
    // =================================================================
    
    // 监听钱包账户或网络切换
    if (typeof window.ethereum !== 'undefined') {
        window.ethereum.on('chainChanged', () => {
            window.location.reload();
        });
        window.ethereum.on('accountsChanged', (accounts) => {
            if (accounts.length === 0) {
                window.location.reload(); // 用户断开连接
            } else {
                currentAccount = accounts[0];
                setupContractsAndUI();
            }
        });
    }

    // 页面加载完成后，检查是否有已连接账户
    window.onload = checkWalletExists;
</script>
</body>
</html>
