<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odog ç•™è¨€å¢™ NFT é“¸é€ </title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #15202b; color: #fff; text-align: center; padding: 20px; }
        .container { max-width: 600px; margin: 50px auto; background-color: #1e2a3a; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
        h1 { color: #50e3c2; }
        button { background-color: #50e3c2; color: #1e2a3a; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; margin: 10px; }
        button:hover { background-color: #3cb89c; }
        textarea { width: 90%; height: 100px; padding: 10px; margin: 15px 0; border: 1px solid #3c4a5d; background-color: #273444; color: #fff; border-radius: 6px; resize: vertical; }
        .info { margin-top: 20px; padding: 15px; background-color: #273444; border-radius: 6px; text-align: left; }
        .error { color: #ff6b6b; font-weight: bold; }
        .success { color: #50e3c2; font-weight: bold; }
        .disabled-button { background-color: #4a4a4a; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Odog ç•™è¨€å¢™ NFT é“¸é€ </h1>
        <p>ç½‘ç»œ: X Layer (ID: 196) | è´¹ç”¨: 100 ODOG (éœ€è¦æˆæƒ)</p>
        
        <button id="connectButton">è¿æ¥ MetaMask</button>
        <p id="statusMessage" class="info">è¯·å…ˆè¿æ¥æ‚¨çš„é’±åŒ…ã€‚</p>

        <hr>

        <textarea id="messageInput" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ç•™è¨€ (ä¸­æ–‡çº¦160å­—ï¼Œæœ€å¤š500å­—èŠ‚)..." maxlength="500"></textarea>
        
        <button id="mintButton" class="disabled-button" disabled>é“¸é€  NFT</button>

        <p id="result" class="info">çŠ¶æ€ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. é…ç½®ä¿¡æ¯ (å·²æ›´æ–°ä¸ºæ‚¨çš„æ–°åˆçº¦åœ°å€)
        // ----------------------------------------------------
        
        // æ‚¨çš„ OdogMessageWall åˆçº¦åœ°å€
        const NFT_CONTRACT_ADDRESS = "0x2b077a38E41FE4fb99b5458A25C87F07Bc2Ef7CF";
        // ODOG ä»£å¸åœ°å€ (æ¥è‡ªæ‚¨çš„åˆçº¦ä»£ç )
        const ODOG_TOKEN_ADDRESS = "0xc3F431Cd1B7220cCa703Ee08C24ca645A71e72c8";
        // é“¸é€ æ‰€éœ€çš„ ODOG æ•°é‡ (100 ODOG, 18ä½å°æ•°)
        const TOKEN_AMOUNT = ethers.utils.parseUnits("100", 18);
        // X Layer Chain ID
        const TARGET_CHAIN_ID = 196; 

        // ----------------------------------------------------
        // 2. ABI (åªåŒ…å«æˆ‘ä»¬éœ€è¦çš„å‡½æ•°)
        // ----------------------------------------------------

        // OdogMessageWall NFT åˆçº¦çš„ç²¾ç®€ ABI
        const NFT_ABI = [
            "function writeMessage(string message)",
            "function ownerOf(uint256 tokenId) view returns (address)",
        ];

        // IERC20 (ODOG) åˆçº¦çš„ç²¾ç®€ ABI
        const ERC20_ABI = [
            "function allowance(address owner, address spender) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
        ];

        // ----------------------------------------------------
        // 3. Ethers.js å®ä¾‹å’ŒçŠ¶æ€
        // ----------------------------------------------------
        let signer;
        let nftContract;
        let odogContract;
        let currentAccount;

        const statusMessage = document.getElementById('statusMessage');
        const mintButton = document.getElementById('mintButton');
        const connectButton = document.getElementById('connectButton');
        const resultDiv = document.getElementById('result');
        const messageInput = document.getElementById('messageInput');


        // ----------------------------------------------------
        // 4. å‡½æ•°å®šä¹‰
        // ----------------------------------------------------

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                statusMessage.className = 'info error';
                statusMessage.textContent = "æœªæ£€æµ‹åˆ° MetaMaskã€‚è¯·å®‰è£… MetaMask æˆ–ä½¿ç”¨æ”¯æŒ Web3 çš„æµè§ˆå™¨ã€‚";
                return;
            }

            try {
                // è¯·æ±‚è¿æ¥è´¦æˆ·
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // æ£€æŸ¥ç½‘ç»œæ˜¯å¦æ­£ç¡®
                const network = await provider.getNetwork();
                if (network.chainId !== TARGET_CHAIN_ID) {
                    statusMessage.className = 'info error';
                    statusMessage.textContent = `è¯·è¿æ¥åˆ° X Layer (Chain ID: ${TARGET_CHAIN_ID})ã€‚`;
                    return;
                }

                signer = provider.getSigner();
                currentAccount = await signer.getAddress();
                
                // åˆå§‹åŒ–åˆçº¦
                nftContract = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_ABI, signer);
                odogContract = new ethers.Contract(ODOG_TOKEN_ADDRESS, ERC20_ABI, signer);

                statusMessage.className = 'info success';
                statusMessage.textContent = `è¿æ¥æˆåŠŸ! è´¦æˆ·: ${currentAccount.substring(0, 6)}...${currentAccount.substring(38)}`;
                connectButton.textContent = 'å·²è¿æ¥';
                connectButton.disabled = true;
                
                checkApproval();
                
            } catch (error) {
                console.error(error);
                statusMessage.className = 'info error';
                statusMessage.textContent = "è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„é’±åŒ…ã€‚";
            }
        }

        async function checkApproval() {
            resultDiv.textContent = "æ­£åœ¨æ£€æŸ¥ ODOG æˆæƒçŠ¶æ€...";
            
            try {
                // æ£€æŸ¥æ˜¯å¦æˆæƒ NFT åˆçº¦èŠ±è´¹ ODOG
                const allowance = await odogContract.allowance(currentAccount, NFT_CONTRACT_ADDRESS);
                
                if (allowance.gte(TOKEN_AMOUNT)) {
                    resultDiv.className = 'info success';
                    resultDiv.textContent = "ODOG æˆæƒå·²é€šè¿‡ã€‚æ‚¨å¯ä»¥å¼€å§‹é“¸é€ ã€‚";
                    mintButton.classList.remove('disabled-button');
                    mintButton.disabled = false;
                } else {
                    resultDiv.className = 'info';
                    resultDiv.textContent = "æ‚¨éœ€è¦æˆæƒ NFT åˆçº¦èŠ±è´¹ 100 ODOGã€‚è¯·ç‚¹å‡»ä¸‹æ–¹æˆæƒæŒ‰é’®ã€‚";
                    mintButton.textContent = "æˆæƒ ODOG";
                    mintButton.classList.remove('disabled-button');
                    mintButton.disabled = false;
                    mintButton.onclick = approveOdog; // ç»‘å®šæˆæƒå‡½æ•°
                }
            } catch (error) {
                console.error("æ£€æŸ¥æˆæƒå¤±è´¥:", error);
                resultDiv.className = 'info error';
                resultDiv.textContent = "æ£€æŸ¥æˆæƒæ—¶å‘ç”Ÿé”™è¯¯ã€‚";
            }
        }

        async function approveOdog() {
            resultDiv.textContent = "æ­£åœ¨å‘é€æˆæƒäº¤æ˜“...";
            mintButton.disabled = true;

            try {
                // æˆæƒä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œé¿å…æ¯æ¬¡éƒ½æˆæƒ
                const maxUint256 = ethers.constants.MaxUint256; 
                const tx = await odogContract.approve(NFT_CONTRACT_ADDRESS, maxUint255);
                
                resultDiv.textContent = `æˆæƒäº¤æ˜“å·²å‘é€! Hash: ${tx.hash.substring(0, 10)}... æ­£åœ¨ç­‰å¾…ç¡®è®¤...`;
                
                await tx.wait(); // ç­‰å¾…äº¤æ˜“è¢«æ‰“åŒ…
                
                resultDiv.className = 'info success';
                resultDiv.textContent = "æˆæƒæˆåŠŸï¼ç°åœ¨æ‚¨å¯ä»¥é“¸é€  NFTã€‚";
                
                mintButton.textContent = "é“¸é€  NFT";
                mintButton.onclick = mintNFT; // é‡æ–°ç»‘å®šä¸ºé“¸é€ å‡½æ•°
                mintButton.disabled = false;

            } catch (error) {
                console.error("æˆæƒå¤±è´¥:", error);
                resultDiv.className = 'info error';
                resultDiv.textContent = "æˆæƒå¤±è´¥ã€‚è¯·æ£€æŸ¥æ‚¨çš„ MetaMask äº¤æ˜“ã€‚";
                mintButton.disabled = false;
            }
        }

        async function mintNFT() {
            const message = messageInput.value.trim();
            
            if (!message) {
                resultDiv.className = 'info error';
                resultDiv.textContent = "ç•™è¨€å†…å®¹ä¸èƒ½ä¸ºç©ºï¼";
                return;
            }

            // å®¢æˆ·ç«¯æ£€æŸ¥ 500 å­—èŠ‚é™åˆ¶
            if (new TextEncoder().encode(message).length > 500) {
                 resultDiv.className = 'info error';
                resultDiv.textContent = "ç•™è¨€å†…å®¹è¶…è¿‡ 500 å­—èŠ‚é™åˆ¶ï¼è¯·ç¼©çŸ­ã€‚";
                return;
            }

            resultDiv.textContent = "æ­£åœ¨å‘é€é“¸é€ äº¤æ˜“...";
            mintButton.disabled = true;

            try {
                // è°ƒç”¨åˆçº¦çš„ writeMessage å‡½æ•°
                const tx = await nftContract.writeMessage(message);

                resultDiv.textContent = `é“¸é€ äº¤æ˜“å·²å‘é€! Hash: ${tx.hash.substring(0, 10)}... æ­£åœ¨ç­‰å¾…ç¡®è®¤...`;

                await tx.wait(); // ç­‰å¾…äº¤æ˜“è¢«æ‰“åŒ…

                resultDiv.className = 'info success';
                resultDiv.textContent = `ğŸ‰ é“¸é€ æˆåŠŸï¼æ‚¨å¯ä»¥åœ¨åŒºå—é“¾æµè§ˆå™¨ä¸ŠæŸ¥çœ‹äº¤æ˜“ï¼š${tx.hash}`;
                
            } catch (error) {
                console.error("é“¸é€ å¤±è´¥:", error);
                
                let errorMessage = "é“¸é€ å¤±è´¥ã€‚å¯èƒ½æ˜¯æˆæƒä¸è¶³ã€ODOGä½™é¢ä¸è¶³æˆ–ç•™è¨€ä¸ºç©ºã€‚";
                // å°è¯•æå– MetaMask é”™è¯¯ä¿¡æ¯
                if (error.message.includes("execution reverted")) {
                    errorMessage = "é“¸é€ å¤±è´¥: åˆçº¦æ‰§è¡Œè¢«å›é€€ã€‚è¯·æ£€æŸ¥ ODOG ä½™é¢å’Œæˆæƒæ˜¯å¦è¶³å¤Ÿã€‚";
                }
                
                resultDiv.className = 'info error';
                resultDiv.textContent = errorMessage;
                
            } finally {
                mintButton.disabled = false;
            }
        }


        // ----------------------------------------------------
        // 5. äº‹ä»¶ç›‘å¬å™¨
        // ----------------------------------------------------
        
        connectButton.addEventListener('click', connectWallet);
        // é»˜è®¤æƒ…å†µä¸‹ï¼Œé“¸é€ æŒ‰é’®ç‚¹å‡»åæ‰§è¡Œ checkApproval ä¸­ç»‘å®šçš„å‡½æ•°
        
        // ç›‘å¬è´¦æˆ·å’Œç½‘ç»œå˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    connectWallet();
                } else {
                    window.location.reload(); // è´¦æˆ·æ–­å¼€è¿æ¥æ—¶åˆ·æ–°é¡µé¢
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload(); // ç½‘ç»œå˜åŒ–æ—¶åˆ·æ–°é¡µé¢
            });
        }

    </script>
</body>
</html>
