<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odog Message Wall - NFT é“¸é€ </title>
    
    <style>
        /* æ·±è‰²æ¨¡å¼ï¼Œé¿å…åˆºçœ¼ */
        :root {
            --bg-color: #1e1e1e;       /* æ·±ç°è‰²èƒŒæ™¯ */
            --text-color: #f0f0f0;     /* æµ…ç™½è‰²æ–‡å­— */
            --primary-color: #ffb74d;  /* æ©™è‰²/é»„è‰²ï¼Œä½œä¸ºå¼ºè°ƒè‰² */
            --secondary-color: #2a2a2a; /* å¡ç‰‡/åŒºå—èƒŒæ™¯è‰² */
            --border-color: #444;      /* è¾¹æ¡†é¢œè‰² */
            --button-bg: #333;         /* æŒ‰é’®èƒŒæ™¯ */
            --button-hover: #444;      /* æŒ‰é’®æ‚¬åœ */
            --error-color: #ff6b6b;
            --success-color: #6bff97;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Arial', 'Helvetica', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        header {
            background-color: var(--secondary-color);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            color: var(--primary-color);
            font-size: 1.8em;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        h2 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        .cost-info p {
            background-color: var(--secondary-color);
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .mint-section {
            background-color: var(--secondary-color);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        textarea {
            width: 98%;
            height: 150px;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            resize: vertical;
            font-size: 14px;
            font-family: monospace, 'Courier New', Courier, sans-serif;
        }

        button {
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: var(--bg-color); /* æŒ‰é’®æ–‡å­—ä½¿ç”¨æ·±è‰²ï¼Œæé«˜å¯¹æ¯”åº¦ */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        button:hover:not(:disabled) {
            background-color: #ffc973; /* æµ…ä¸€ç‚¹çš„äº®è‰² */
        }

        button:disabled {
            background-color: var(--button-bg);
            color: var(--border-color);
            cursor: not-allowed;
        }

        #statusMessage {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }

        .error {
            color: var(--error-color);
            border: 1px solid var(--error-color);
            background-color: rgba(255, 107, 107, 0.1);
        }

        .success {
            color: var(--success-color);
            border: 1px solid var(--success-color);
            background-color: rgba(107, 255, 151, 0.1);
        }

        .hidden {
            display: none !important;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 50px;
            border-top: 1px solid var(--border-color);
            color: #888;
        }

        footer a {
            color: var(--primary-color);
            text-decoration: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
</head>
<body>
    <header>
        <h1>Odog ç•™è¨€å¢™ NFT</h1>
        <button id="connectWalletBtn">è¿æ¥é’±åŒ…</button>
        <p id="walletInfo" class="hidden">å·²è¿æ¥: <span id="accountAddress"></span></p>
    </header>

    <main class="container">
        <h2>é“¸é€ ä½ çš„ç•™è¨€ NFT</h2>
        
        <div class="cost-info">
            <p>é“¸é€ è´¹ç”¨: **100 ODOG** (å°†é”€æ¯åˆ°é»‘æ´åœ°å€)</p>
            <p>æœ€å¤§ç•™è¨€é•¿åº¦: **500 å­—èŠ‚**</p>
        </div>

        <div class="mint-section">
            <label for="messageInput">è¾“å…¥ä½ çš„ç•™è¨€ (500 å­—èŠ‚é™åˆ¶):</label>
            <textarea id="messageInput" placeholder="å†™ä¸‹ä½ æƒ³åœ¨åŒºå—é“¾ä¸Šç•™ä¸‹çš„æ–‡å­—..." maxlength="500"></textarea>
            
            <button id="mintButton" disabled>è¯·è¿æ¥é’±åŒ…ä»¥é“¸é€ </button>
            <p id="statusMessage"></p>
        </div>

        </main>

    <footer>
        <p>&copy; 2024 Odog Message Wall</p>
        <p>åˆçº¦åœ°å€: <a href="https://www.oklink.com/xlayer/address/0x91e84D5fB4377C6612dcAe56395f1C225Da6b47f" target="_blank">0x91e8...47f</a></p>
    </footer>

    <script>
        // æ ¸å¿ƒåˆçº¦ä¿¡æ¯
        const ODOG_MESSAGE_WALL_ADDRESS = '0x91e84D5fB4377C6612dcAe56395f1C225Da6b47f';
        const ODOG_TOKEN_ADDRESS = '0xc3F431Cd1B7220cCa703Ee08C24ca645A71e72c8';
        const ODOG_CHAIN_ID = 196; // X Layer Chain ID

        // ä½ çš„ OdogMessageWall åˆçº¦ ABI (åªåŒ…å«éœ€è¦ç”¨åˆ°çš„å‡½æ•°)
        const ODOG_MESSAGE_WALL_ABI = [
            "function writeMessage(string calldata message) external",
        ];

        // ODOG ä»£å¸åˆçº¦ ABI (åªåŒ…å« approve å‡½æ•°)
        const ODOG_TOKEN_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
        ];

        // é“¸é€ æ‰€éœ€çš„ç²¾ç¡®ä»£å¸é‡ (100 åé¢è·Ÿ 18 ä¸ª 0)
        const ODOG_AMOUNT = BigInt("100000000000000000000"); 

        // DOM å…ƒç´ 
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const mintButton = document.getElementById('mintButton');
        const messageInput = document.getElementById('messageInput');
        const statusMessage = document.getElementById('statusMessage');
        const accountAddress = document.getElementById('accountAddress');
        const walletInfo = document.getElementById('walletInfo');

        let provider;
        let signer;
        let currentAccount = null;

        // --- è¾…åŠ©å‡½æ•° ---

        function updateStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'error' : 'success';
            if (!message) {
                statusMessage.className = '';
            }
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç½‘ç»œ (X Layer: 196)
        async function checkNetwork() {
            try {
                const { chainId } = await provider.getNetwork();
                if (Number(chainId) !== ODOG_CHAIN_ID) {
                    updateStatus(`é”™è¯¯: è¯·åˆ‡æ¢åˆ° X Layer (Chain ID: ${ODOG_CHAIN_ID})`, true);
                    mintButton.disabled = true;
                    mintButton.textContent = "ç½‘ç»œé”™è¯¯";
                    return false;
                }
                return true;
            } catch (e) {
                console.error("æ— æ³•è·å–ç½‘ç»œä¿¡æ¯:", e);
                return false;
            }
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æˆæƒè¶³å¤Ÿé‡‘é¢
        async function checkAllowance() {
            if (!currentAccount) return false;

            try {
                const odogContract = new ethers.Contract(ODOG_TOKEN_ADDRESS, ODOG_TOKEN_ABI, provider);
                const allowance = await odogContract.allowance(currentAccount, ODOG_MESSAGE_WALL_ADDRESS);

                if (allowance >= ODOG_AMOUNT) {
                    mintButton.disabled = false;
                    mintButton.textContent = "æ­¥éª¤ 2/2: é“¸é€ ç•™è¨€ NFT";
                    return true;
                } else {
                    mintButton.disabled = false;
                    mintButton.textContent = "æ­¥éª¤ 1/2: æˆæƒ 100 ODOG";
                    return false;
                }
            } catch (error) {
                console.error("æ£€æŸ¥æˆæƒå¤±è´¥:", error);
                updateStatus("æ£€æŸ¥æˆæƒå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚", true);
                mintButton.disabled = true;
                return false;
            }
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---

        // 1. è¿æ¥é’±åŒ…
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                updateStatus("è¯·å®‰è£… MetaMask æˆ–å…¶ä»– Web3 é’±åŒ…ã€‚", true);
                return;
            }

            try {
                // ä½¿ç”¨ Ethers.js v6 çš„æµè§ˆå™¨æä¾›ç¨‹åº
                provider = new ethers.BrowserProvider(window.ethereum);

                // è¯·æ±‚è´¦æˆ·è¿æ¥
                const accounts = await provider.send("eth_requestAccounts", []);
                currentAccount = accounts[0];
                signer = await provider.getSigner();

                // æ›´æ–° UI
                accountAddress.textContent = `${currentAccount.substring(0, 6)}...${currentAccount.substring(currentAccount.length - 4)}`;
                walletInfo.classList.remove('hidden');
                connectWalletBtn.classList.add('hidden');
                mintButton.disabled = true; // é»˜è®¤ç¦ç”¨ï¼Œç­‰å¾…æ£€æŸ¥

                if (await checkNetwork()) {
                    await checkAllowance();
                }

                // ç›‘å¬è´¦æˆ·å’Œç½‘ç»œå˜åŒ–
                window.ethereum.on('accountsChanged', (newAccounts) => {
                    if (newAccounts.length === 0) {
                        window.location.reload();
                    } else {
                        currentAccount = newAccounts[0];
                        connectWallet();
                    }
                });
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });

            } catch (error) {
                console.error("è¿æ¥é’±åŒ…å¤±è´¥:", error);
                updateStatus("è¿æ¥é’±åŒ…å¤±è´¥ã€‚è¯·æ£€æŸ¥é’±åŒ…æƒé™ã€‚", true);
            }
        }

        // 2. å¤„ç†é“¸é€ æµç¨‹
        async function handleMint() {
            if (!signer) {
                updateStatus("è¯·å…ˆè¿æ¥é’±åŒ…ã€‚", true);
                return;
            }

            const message = messageInput.value.trim();
            if (message.length === 0) {
                updateStatus("ç•™è¨€å†…å®¹ä¸èƒ½ä¸ºç©ºã€‚", true);
                return;
            }
            // ä½¿ç”¨ TextEncoder æ£€æŸ¥å­—èŠ‚é•¿åº¦ (æ”¯æŒä¸­æ–‡ç­‰å¤šå­—èŠ‚å­—ç¬¦)
            if (new TextEncoder().encode(message).length > 500) {
                updateStatus("ç•™è¨€é•¿åº¦è¶…è¿‡ 500 å­—èŠ‚é™åˆ¶ã€‚", true);
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            mintButton.disabled = true;
            updateStatus("æ­£åœ¨å¤„ç†äº¤æ˜“...", false);

            try {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æˆæƒ
                const isApproved = await checkAllowance();

                if (!isApproved) {
                    // --- æ­¥éª¤ 1: æˆæƒä»£å¸ ---
                    const odogContract = new ethers.Contract(ODOG_TOKEN_ADDRESS, ODOG_TOKEN_ABI, signer);
                    updateStatus("å‘é€æˆæƒäº¤æ˜“...è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ã€‚", false);

                    const tx = await odogContract.approve(ODOG_MESSAGE_WALL_ADDRESS, ODOG_AMOUNT);
                    updateStatus(`æˆæƒäº¤æ˜“å‘é€: ${tx.hash}. ç­‰å¾…ç¡®è®¤...`, false);
                    
                    await tx.wait();
                    updateStatus("æˆæƒæˆåŠŸ! ç°åœ¨å¯ä»¥é“¸é€  NFTã€‚", true);
                    
                    // æˆæƒæˆåŠŸåå†æ¬¡æ£€æŸ¥ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
                    await checkAllowance(); 
                    return;
                }

                // --- æ­¥éª¤ 2: é“¸é€  NFT ---
                const wallContract = new ethers.Contract(ODOG_MESSAGE_WALL_ADDRESS, ODOG_MESSAGE_WALL_ABI, signer);
                updateStatus("å‘é€é“¸é€ äº¤æ˜“...è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ã€‚", false);
                
                const tx = await wallContract.writeMessage(message);
                updateStatus(`é“¸é€ äº¤æ˜“å‘é€: ${tx.hash}. ç­‰å¾…ç¡®è®¤...`, false);
                
                await tx.wait();
                
                updateStatus("ğŸ‰ æ­å–œ! NFT é“¸é€ æˆåŠŸ!", true);
                messageInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

            } catch (error) {
                console.error("äº¤æ˜“å¤±è´¥:", error);
                
                let errorMessage = "äº¤æ˜“å¤±è´¥ã€‚";
                if (error.code === 4001) {
                    errorMessage = "äº¤æ˜“è¢«ç”¨æˆ·æ‹’ç»ã€‚";
                } else if (error.message.includes("transfer caller is not owner nor approved")) {
                    errorMessage = "é“¸é€ å¤±è´¥ï¼Œè¯·ç¡®ä¿ä½ å·²å®Œæˆä»£å¸æˆæƒã€‚";
                } else {
                    errorMessage += ` è¯¦æƒ…: ${error.message.substring(0, 80)}...`;
                }

                updateStatus(errorMessage, true);

            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                await checkAllowance(); 
            }
        }

        // --- äº‹ä»¶ç›‘å¬ ---

        connectWalletBtn.addEventListener('click', connectWallet);
        mintButton.addEventListener('click', handleMint);

        // åˆå§‹åŒ–æ£€æŸ¥
        if (typeof window.ethereum !== 'undefined') {
            connectWalletBtn.textContent = "è¿æ¥é’±åŒ…";
        } else {
            connectWalletBtn.textContent = "å®‰è£… MetaMask";
        }
    </script>
</body>
</html>
