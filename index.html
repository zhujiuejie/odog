<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Odog NFT 铸造</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --text: #c9d1d9;
      --accent: #58a6ff;
      --success: #2f855a;
      --error: #e53e3e;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 600px;
      background: var(--card);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #30363d;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    h1 {
      color: var(--accent);
      text-align: center;
      margin-bottom: 20px;
    }
    .message-input {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #30363d;
      background: transparent;
      color: var(--text);
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-direction: column;
    }
    button {
      padding: 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      color: #fff;
    }
    .btn-connect { background: #38a169; }
    .btn-approve { background: #e3a62d; }
    .btn-mint { background: #4299e1; }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .warning {
      color: var(--error);
      font-size: 0.9rem;
      margin-top: 10px;
      text-align: center;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .status-info { background: #4299e140; color: var(--accent); }
    .status-success { background: #2f855a40; color: var(--success); }
    .status-error { background: #e53e3e40; color: var(--error); }
  </style>
</head>
<body>
  <div class="container">
    <h1>Odog NFT 铸造</h1>
    <textarea class="message-input" id="message-input" placeholder="输入你的留言（500 字节限制）"></textarea>
    <div class="controls">
      <button id="connect-button" class="btn-connect">连接钱包</button>
      <button id="approve-button" class="btn-approve" disabled>授权 100 ODOG</button>
      <button id="mint-button" class="btn-mint" disabled>铸造 NFT</button>
    </div>
    <div class="warning">注意：铸造 NFT 将永久销毁 100 ODOG！</div>
    <div id="status" class="status status-info">准备就绪，请连接钱包。</div>
  </div>

  <script>
    const NFT_CONTRACT_ADDRESS = "0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917";
    const ODOG_TOKEN_ADDRESS = "0xc3f431cd1b7220cca703ee08c24ca645a71e72c8";
    const CHAIN_ID_DECIMAL = 196;
    const CHAIN_ID_HEX = ethers.utils.hexValue(CHAIN_ID_DECIMAL);
    const ODOG_AMOUNT = ethers.utils.parseUnits("100", 18);

    const RPC_OPTIONS = ["https://rpc.xlayer.tech", "https://xlayerrpc.okx.com"];
    const BLOCK_EXPLORER = "https://www.oklink.com/xlayer";

    const ERC20_ABI = [
      {"constant": true, "inputs": [{"internalType": "address", "name": "owner", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
      {"constant": true, "inputs": [{"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "address", "name": "spender", "type": "address"}], "name": "allowance", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
      {"constant": false, "inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "approve", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"}
    ];

    const NFT_CONTRACT_ABI = [
      {"constant": false, "inputs": [{"internalType": "string", "name": "message", "type": "string"}], "name": "writeMessage", "outputs": [], "stateMutability": "nonpayable", "type": "function"}
    ];

    const connectButton = document.getElementById('connect-button');
    const approveButton = document.getElementById('approve-button');
    const mintButton = document.getElementById('mint-button');
    const messageInput = document.getElementById('message-input');
    const statusDiv = document.getElementById('status');

    let provider = null;
    let signer = null;
    let nftContract = null;
    let odogContract = null;
    let currentAccount = null;

    function setStatus(msg, type = 'info') {
      statusDiv.textContent = msg;
      statusDiv.className = `status status-${type}`;
    }

    async function connectWallet() {
      try {
        if (typeof window.ethereum === 'undefined') {
          setStatus('未检测到钱包插件，请安装 MetaMask 或 OKX Wallet。', 'error');
          return;
        }
        provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
        signer = provider.getSigner();
        setStatus('请求连接钱包，请在钱包中确认...', 'info');
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (!accounts || accounts.length === 0) {
          setStatus('未获取到账户，请在钱包中解锁并授权。', 'error');
          return;
        }
        currentAccount = accounts[0];
        setStatus(`钱包连接成功：${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`, 'success');
        connectButton.disabled = true;
        connectButton.textContent = '已连接';

        nftContract = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer);
        odogContract = new ethers.Contract(ODOG_TOKEN_ADDRESS, ERC20_ABI, signer);

        await checkAllowance();
      } catch (e) {
        console.error(e);
        setStatus('连接失败：' + (e.message || '请检查钱包设置'), 'error');
        connectButton.disabled = false;
      }
    }

    async function checkAllowance() {
      try {
        const allowance = await odogContract.allowance(currentAccount, NFT_CONTRACT_ADDRESS);
        if (allowance.lt(ODOG_AMOUNT)) {
          setStatus('请先授权 100 ODOG', 'info');
          approveButton.disabled = false;
          mintButton.disabled = true;
        } else {
          setStatus('已授权，可铸造 NFT', 'success');
          approveButton.disabled = true;
          mintButton.disabled = false;
        }
      } catch (e) {
        console.error(e);
        setStatus('检查授权失败：' + (e.message || '请重试'), 'error');
      }
    }

    async function approveODOG() {
      try {
        approveButton.disabled = true;
        approveButton.textContent = '授权中...';
        setStatus('发送授权交易，请在钱包中确认...', 'info');
        const tx = await odogContract.approve(NFT_CONTRACT_ADDRESS, ethers.constants.MaxUint256);
        await tx.wait();
        setStatus('授权成功！', 'success');
        await checkAllowance();
      } catch (e) {
        console.error(e);
        setStatus('授权失败：' + (e.message || '用户可能拒绝交易'), 'error');
        approveButton.disabled = false;
        approveButton.textContent = '授权 100 ODOG';
      }
    }

    async function mintNFT() {
      try {
        const message = messageInput.value.trim();
        if (!message) {
          setStatus('留言不能为空', 'error');
          return;
        }
        if (ethers.utils.toUtf8Bytes(message).length > 500) {
          setStatus('留言超过 500 字节限制', 'error');
          return;
        }
        if (!confirm('确认铸造 NFT？此操作将永久销毁 100 ODOG！')) {
          setStatus('铸造已取消', 'info');
          return;
        }

        mintButton.disabled = true;
        mintButton.textContent = '铸造中...';
        setStatus('发送铸造交易，请在钱包中确认...', 'info');
        const tx = await nftContract.writeMessage(message);
        const receipt = await tx.wait();
        setStatus(`铸造成功！交易哈希：${receipt.transactionHash}`, 'success');
        messageInput.value = '';
        mintButton.disabled = true;
      } catch (e) {
        console.error(e);
        setStatus('铸造失败：' + (e.message || '请检查网络或余额'), 'error');
        mintButton.disabled = false;
        mintButton.textContent = '铸造 NFT';
      }
    }

    connectButton.addEventListener('click', connectWallet);
    approveButton.addEventListener('click', approveODOG);
    mintButton.addEventListener('click', mintNFT);
  </script>
</body>
</html>
