<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Odog 链上留言 NFT 铸造终端</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <style>
    body {
      font-family: 'Consolas', 'Courier New', monospace;
      background-color: #0d1117;
      color: #c9d1d9;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      background-color: #161b22;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(66, 153, 225, 0.4);
      max-width: 650px;
      width: 100%;
      border: 1px solid #30363d;
    }
    h1 {
      color: #58a6ff;
      text-align: center;
      margin-bottom: 5px;
      font-size: 1.8em;
    }
    .subtitle {
      text-align: center;
      color: #8b949e;
      font-size: 0.9em;
      margin-bottom: 25px;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #30363d;
      border-radius: 6px;
      background-color: #0d1117;
      color: #58a6ff;
      resize: none;
      box-sizing: border-box;
      font-size: 1em;
    }
    .button-group {
      display: flex;
      gap: 10px;
    }
    button {
      flex-grow: 1;
      padding: 15px;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.2s, opacity 0.2s;
    }
    #connect-button { background-color: #38a169; }
    #connect-button:hover:not(:disabled) { background-color: #2f855a; }
    #approve-button { background-color: #e3a62d; }
    #approve-button:hover:not(:disabled) { background-color: #c08500; }
    #mint-button { background-color: #4299e1; }
    #mint-button:hover:not(:disabled) { background-color: #3182ce; }
    button:disabled {
      background-color: #4a5568;
      cursor: not-allowed;
      opacity: 0.6;
    }
    #status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      text-align: left;
      word-break: break-all;
      display: none;
      border: 1px solid #30363d;
      font-size: 0.9em;
    }
    .success { background-color: #2f855a40; color: #48bb78; }
    .error { background-color: #e53e3e40; color: #fc8181; }
    .info { background-color: #4299e140; color: #58a6ff; }
    #wallet-info {
      margin-bottom: 20px;
      text-align: center;
      font-size: 0.9em;
      color: #8b949e;
    }
    .burn-warning {
      color: #fc8181;
      font-weight: bold;
      margin-top: 10px;
      text-align: center;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Odog 链上留言终端</h1>
  <div class="subtitle">
    由 **Gemini** 在 **4.2 秒**内架构设计。<br>
    合约地址: <code style="color: #48bb78;">0x8ed8...7917</code> | 网络ID: <code style="color: #48bb78;">196</code>
  </div>
  <div id="wallet-info">请点击“连接钱包”开始操作...</div>
  <textarea id="message-input" placeholder="输入你想永久记录在区块链上的留言... (500字节限制)"></textarea>
  <div class="button-group">
    <button id="connect-button" onclick="connectWallet()">连接钱包</button>
    <button id="approve-button" onclick="approveODOG()" disabled>授权 ODOG (第一步)</button>
    <button id="mint-button" onclick="mintMessage()" disabled>铸造 NFT (第二步)</button>
  </div>
  <div class="burn-warning">注意：铸造将花费 100 ODOG，并将其**永久销毁**。</div>
  <div id="status-message"></div>
</div>

<script>
  const CONTRACT_ADDRESS = "0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917";
  const CHAIN_ID_DECIMAL = 196; 
  const ODOG_TOKEN_ADDRESS = "0xc3F431Cd1B7220cCa703Ee08C24ca645A71e72c8";
  const ODOG_AMOUNT = ethers.utils.parseUnits("100", 18);

  const ERC20_ABI = [
    { "constant": false, "inputs": [{"name": "spender", "type": "address"}, {"name": "amount", "type": "uint256"}], "name": "approve", "outputs": [{"name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function" },
    { "constant": true, "inputs": [{"name": "owner", "type": "address"}, {"name": "spender", "type": "address"}], "name": "allowance", "outputs": [{"name": "", "type": "uint256"}], "stateMutability": "view", "type": "function" },
    { "constant": true, "inputs": [{"name": "owner", "type": "address"}], "name": "balanceOf", "outputs": [{"name": "", "type": "uint256"}], "stateMutability": "view", "type": "function" }
  ];

  const CONTRACT_ABI = [{"constant":false,"inputs":[{"internalType":"string","name":"message","type":"string"}],"name":"writeMessage","outputs":[],"stateMutability":"nonpayable","type":"function"}];

  const statusDiv = document.getElementById('status-message');
  const connectButton = document.getElementById('connect-button');
  const approveButton = document.getElementById('approve-button');
  const mintButton = document.getElementById('mint-button');
  const walletInfoDiv = document.getElementById('wallet-info');
  const messageInput = document.getElementById('message-input');

  let provider, signer, contract, odogContract, currentAccount = null;

  function setStatus(message, isError = false, isInfo = false) {
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';
    statusDiv.className = isError ? 'error' : (isInfo ? 'info' : 'success');
  }

  async function connectWallet() {
    if (typeof window.ethereum === 'undefined') {
      setStatus("❌ 未检测到 Web3 钱包，请安装 MetaMask 或 OKX。", true);
      return;
    }

    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();

    try {
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      currentAccount = accounts[0];
      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
      odogContract = new ethers.Contract(ODOG_TOKEN_ADDRESS, ERC20_ABI, signer);
      await updateUIState();
    } catch (err) {
      console.error(err);
      setStatus("连接失败：" + (err.message || err), true);
    }
  }

  async function updateUIState() {
    const { chainId } = await provider.getNetwork();
    walletInfoDiv.innerHTML = `账户: <strong>${currentAccount.substring(0,6)}...${currentAccount.substring(38)}</strong> | 网络ID: <strong>${chainId}</strong>`;
    if (chainId !== CHAIN_ID_DECIMAL) {
      setStatus(`⚠️ 请切换到 Chain ID ${CHAIN_ID_DECIMAL}`, true);
      return;
    }

    const balance = await odogContract.balanceOf(currentAccount);
    if (balance.lt(ODOG_AMOUNT)) {
      setStatus("余额不足，至少需要 100 ODOG。", true);
      return;
    }

    const allowance = await odogContract.allowance(currentAccount, CONTRACT_ADDRESS);
    if (allowance.gte(ODOG_AMOUNT)) {
      approveButton.disabled = true;
      mintButton.disabled = false;
      setStatus("✅ 已授权，可以铸造 NFT。", false);
    } else {
      approveButton.disabled = false;
      mintButton.disabled = true;
      setStatus("请先授权合约使用 100 ODOG。", false, true);
    }
  }

  async function approveODOG() {
    try {
      const tx = await odogContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
      setStatus("授权交易已发送: " + tx.hash, false, true);
      await tx.wait();
      setStatus("✅ 授权成功！", false);
      await updateUIState();
    } catch (err) {
      setStatus("授权失败：" + (err.message || err), true);
    }
  }

  async function mintMessage() {
    const message = messageInput.value.trim();
    if (!message) {
      setStatus("留言不能为空。", true);
      return;
    }
    if (ethers.utils.toUtf8Bytes(message).length > 500) {
      setStatus("留言超过 500 字节限制。", true);
      return;
    }
    try {
      const tx = await contract.writeMessage(message);
      setStatus("交易已发送: " + tx.hash, false, true);
      await tx.wait();
      setStatus("✅ 铸造成功！", false);
      messageInput.value = "";
    } catch (err) {
      setStatus("铸造失败：" + (err.message || err), true);
    }
  }

  if (typeof window.ethereum !== 'undefined') {
    window.ethereum.on('chainChanged', () => location.reload());
    window.ethereum.on('accountsChanged', () => location.reload());
  }
</script>
</body>
</html>
