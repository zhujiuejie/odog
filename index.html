<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odog Message Wall</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">
    <div id="root"></div>
    <script type="text/babel">
        const { ethers } = window.ethers;
        const contractAddress = "YOUR_CONTRACT_ADDRESS"; // 请替换为你的 OdogMessageWall 合约地址
        const odogTokenAddress = "0xc3F431Cd1B7220cCa703Ee08C24ca645A71e72c8";
        const contractABI = [
            {"constant":false,"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},
            {"constant":false,"inputs":[],"name":"ODOG_TOKEN","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":false,"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getMessage","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":false,"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":false,"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":false,"inputs":[{"internalType":"string","name":"message","type":"string"}],"name":"writeMessage","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}
        ];
        const odogTokenABI = [
            {"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":false,"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"}
        ];

        function App() {
            const [account, setAccount] = React.useState(null);
            const [message, setMessage] = React.useState("");
            const [totalSupply, setTotalSupply] = React.useState(0);
            const [previewTokenId, setPreviewTokenId] = React.useState("");
            const [nftPreview, setNftPreview] = React.useState(null);
            const [error, setError] = React.useState("");
            const [loading, setLoading] = React.useState(false);

            const connectWallet = async () => {
                if (window.ethereum) {
                    try {
                        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                        setAccount(accounts[0]);
                        await fetchTotalSupply();
                    } catch (err) {
                        setError("连接钱包失败: " + err.message);
                    }
                } else {
                    setError("请安装 MetaMask");
                }
            };

            const fetchTotalSupply = async () => {
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const contract = new ethers.Contract(contractAddress, contractABI, provider);
                    const supply = await contract.totalSupply();
                    setTotalSupply(supply.toString());
                } catch (err) {
                    setError("获取总供应量失败: " + err.message);
                }
            };

            const mintNFT = async () => {
                if (!account) {
                    setError("请先连接钱包");
                    return;
                }
                if (!message) {
                    setError("请输入留言");
                    return;
                }
                setLoading(true);
                setError("");
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(contractAddress, contractABI, signer);
                    const odogContract = new ethers.Contract(odogTokenAddress, odogTokenABI, signer);

                    // 授权 ODOG 代币
                    const amount = ethers.parseUnits("1", 18);
                    const approveTx = await odogContract.approve(contractAddress, amount);
                    await approveTx.wait();

                    // 铸造 NFT
                    const tx = await contract.writeMessage(message);
                    await tx.wait();
                    setMessage("");
                    await fetchTotalSupply();
                    alert("NFT 铸造成功！");
                } catch (err) {
                    setError("铸造失败: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const previewNFT = async () => {
                if (!previewTokenId) {
                    setError("请输入 Token ID");
                    return;
                }
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const contract = new ethers.Contract(contractAddress, contractABI, provider);
                    const uri = await contract.tokenURI(previewTokenId);
                    setNftPreview(uri);
                    setError("");
                } catch (err) {
                    setError("获取 NFT 失败: " + err.message);
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-6">
                    <h1 className="text-4xl font-bold text-center mb-6">Odog Message Wall</h1>
                    <p className="text-center mb-4">用 1 ODOG 铸造你的留言 NFT，永久上链！</p>

                    <div className="mb-6">
                        <button
                            onClick={connectWallet}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                        >
                            {account ? `已连接: ${account.slice(0, 6)}...${account.slice(-4)}` : "连接钱包"}
                        </button>
                    </div>

                    <div className="mb-6">
                        <h2 className="text-2xl font-semibold mb-2">铸造留言 NFT</h2>
                        <input
                            type="text"
                            value={message}
                            onChange={(e) => setMessage(e.target.value)}
                            placeholder="输入你的留言"
                            className="w-full p-2 mb-2 bg-gray-800 text-white rounded"
                        />
                        <button
                            onClick={mintNFT}
                            disabled={loading}
                            className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50"
                        >
                            {loading ? "铸造中..." : "铸造 NFT (1 ODOG)"}
                        </button>
                    </div>

                    <div className="mb-6">
                        <h2 className="text-2xl font-semibold mb-2">你的 NFT 预览</h2>
                        <input
                            type="text"
                            value={previewTokenId}
                            onChange={(e) => setPreviewTokenId(e.target.value)}
                            placeholder="输入 Token ID 查看 NFT"
                            className="w-full p-2 mb-2 bg-gray-800 text-white rounded"
                        />
                        <button
                            onClick={previewNFT}
                            className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded"
                        >
                            查看
                        </button>
                        {nftPreview && (
                            <div className="mt-4">
                                <img src={nftPreview} alt="NFT Preview" className="w-full rounded" />
                            </div>
                        )}
                    </div>

                    <div className="mb-6">
                        <h2 className="text-2xl font-semibold mb-2">总供应</h2>
                        <p className="text-lg">{totalSupply}</p>
                        <button
                            onClick={fetchTotalSupply}
                            className="mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded"
                        >
                            刷新
                        </button>
                    </div>

                    {error && <p className="text-red-500 text-center">{error}</p>}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById("root"));
    </script>
</body>
</html>
