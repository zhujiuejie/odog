<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ODog NFT 铸造调试版</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    button { padding: 10px 20px; margin: 10px 0; }
    #log { background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: auto; font-size: 12px; }
  </style>
</head>
<body>
  <h1>ODog NFT 铸造调试版</h1>
  <button id="connectBtn">连接钱包</button>
  <button id="testBtn">测试钱包连接</button>
  <div id="status">状态: 未连接</div>
  <h3>调试日志：</h3>
  <pre id="log"></pre>

  <script>
    // --- 配置参数 ---
    const NFT_CONTRACT_ADDRESS = "0x你的NFT合约地址"; 
    const MARKETPLACE_CONTRACT_ADDRESS = "0x你的市场合约地址"; 
    const CHAIN_ID_DECIMAL = 1; // 1=以太坊主网，根据实际改

    let provider, signer, currentAccount;

    // --- 工具函数 ---
    function log(msg) {
      console.log(msg);
      const logEl = document.getElementById("log");
      logEl.textContent += msg + "\\n";
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setStatus(msg) {
      document.getElementById("status").innerText = "状态: " + msg;
      log("[状态] " + msg);
    }

    // --- 连接钱包 ---
    document.getElementById("connectBtn").onclick = async () => {
      log("点击了【连接钱包】按钮");
      if (typeof window.ethereum === "undefined") {
        setStatus("❌ 没检测到钱包，请安装 MetaMask 或 OKX Wallet 插件");
        return;
      }

      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();

      try {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        currentAccount = accounts[0];
        setStatus("✅ 已连接: " + currentAccount);
        log("当前账户: " + currentAccount);

        // 获取链 ID
        const network = await provider.getNetwork();
        log("当前网络 ChainId = " + network.chainId);

        if (network.chainId !== CHAIN_ID_DECIMAL) {
          try {
            await provider.send("wallet_switchEthereumChain", [{ chainId: ethers.utils.hexValue(CHAIN_ID_DECIMAL) }]);
            log("已请求切换网络到 " + CHAIN_ID_DECIMAL);
          } catch (err) {
            log("切换网络失败: " + err.message);
          }
        }
      } catch (err) {
        setStatus("连接失败: " + err.message);
        log("错误: " + err.stack);
      }
    };

    // --- 最小化测试按钮 ---
    document.getElementById("testBtn").onclick = async () => {
      log("点击了【测试钱包连接】按钮");
      if (typeof window.ethereum === "undefined") {
        log("window.ethereum 未定义");
        return;
      }
      try {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        log("测试获取账户成功: " + accounts[0]);
      } catch (e) {
        log("测试获取账户失败: " + e.message);
      }
    };

    // 页面加载时打印环境信息
    window.onload = () => {
      if (typeof window.ethereum === "undefined") {
        log("⚠️ 页面加载: 没检测到 window.ethereum");
      } else {
        log("✅ 页面加载: 检测到钱包插件");
      }
    };
  </script>
</body>
</html>
