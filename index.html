<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Odog NFT 铸造</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; text-align: center; }
    .container { max-width: 500px; margin: 0 auto; background: #161b22; padding: 20px; border-radius: 8px; border: 1px solid #30363d; }
    h1 { color: #58a6ff; }
    textarea { width: 100%; height: 100px; background: transparent; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; padding: 10px; }
    .buttons { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
    button { padding: 12px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }
    #connect { background: #38a169; }
    #approve { background: #e3a62d; }
    #mint { background: #4299e1; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .warning { color: #e53e3e; font-size: 0.9em; margin: 10px 0; }
    #status { padding: 10px; border-radius: 4px; margin-top: 10px; }
    .info { background: rgba(88, 166, 255, 0.1); color: #58a6ff; }
    .success { background: rgba(47, 133, 90, 0.1); color: #2f855a; }
    .错误 { 背景: rgba(229, 62, 62, 0.1); 颜色: #e53e3e; }
  </样式>
</头>
<身体>
  <div 类="容器">
    <h1>Odog NFT 铸造终端</h1>
    <textarea id="message" placeholder="输入留言（限500字节）"></textarea>
    <div class="buttons">
      <button id="connect">连接钱包</button>
      <button id="approve" disabled>授权 100 ODOG</button>
      <button id="mint" disabled>铸造 NFT</button>
    </div>
    <div class="warning">⚠️ 警告：铸造将永久销毁 100 ODOG，不可逆！</div>
    <div id="status" class="info">点击连接钱包开始</div>
  </div>

  <script>
    // 配置
    const NFT_ADDR = '0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917';
    const ODOG_ADDR = '0xc3f431cd1b7220cca703ee08c24ca645a71e72c8';
    const CHAIN_ID = 196;
    const ODOG_AMT = ethers.utils.parseUnits('100', 18);

    // ABI (简化，只需核心)
    const ERC20_ABI = [
      'function balanceOf(address) view returns (uint256)',
      'function allowance(address,address) view returns (uint256)',
      'function approve(address,uint256) returns (bool)'
    ];
    const NFT_ABI = ['function writeMessage(string)'];

    let provider, signer, odog, nft, account;

    function updateStatus(msg, type = 'info') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = type;
      console.log(`[Status ${type.toUpperCase()}]: ${msg}`);
    }

    // 检查 ethers 加载
    if (typeof ethers === 'undefined') {
      updateStatus('ethers.js 加载失败，请刷新页面', 'error');
      throw new Error('No ethers');
    }
    console.log('[Debug] ethers 加载成功');

    // 事件绑定 - 等 DOM 加载完
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Debug] DOM 加载完成，开始绑定按钮');
      
      document.getElementById('connect').addEventListener('click', connectWallet);
      document.getElementById('approve').addEventListener('click', approveODOG);
      document.getElementById('mint').addEventListener('click', mintNFT);

      console.log('[Debug] 所有按钮绑定完成');
    });

    async function connectWallet() {
      console.log('[Debug] 连接按钮被点击！');
      const btn = document.getElementById('connect');
      btn.disabled = true;
      btn.textContent = '连接中...';
      try {
        if (!window.ethereum) {
          updateStatus('未检测到钱包！安装 MetaMask/OKX', 'error');
          throw new Error('No wallet');
        }
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = provider.getSigner();
        account = await signer.getAddress();
        updateStatus(`连接成功: ${account.slice(0,6)}...${account.slice(-4)}`, 'success');
        btn.textContent = '已连接';

        // 检查链
        const net = await provider.getNetwork();
        if (net.chainId !== CHAIN_ID) {
          updateStatus(`请切换到 Chain ID ${CHAIN_ID} (X Layer)`, 'error');
          return;
        }

        // 初始化合约
        odog = new ethers.Contract(ODOG_ADDR, ERC20_ABI, signer);
        nft = new ethers.Contract(NFT_ADDR, NFT_ABI, signer);
        await checkApproval();
      } catch (err) {
        console.error('[Connect Error]', err);
        updateStatus('连接失败: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = '连接钱包';
      }
    }

    async function checkApproval() {
      try {
        const allow = await odog.allowance(account, NFT_ADDR);
        if (allow.lt(ODOG_AMT)) {
          updateStatus('需授权 100 ODOG', 'info');
          document.getElementById('approve').disabled = false;
          document.getElementById('mint').disabled = true;
        } else {
          updateStatus('已授权，可铸造', 'success');
          document.getElementById('approve').disabled = true;
          document.getElementById('mint').disabled = false;
        }
      } catch (err) {
        updateStatus('检查授权失败: ' + err.message, 'error');
      }
    }

    async function approveODOG() {
      console.log('[Debug] 授权按钮被点击！');
      const btn = document.getElementById('approve');
      btn.disabled = true;
      btn.textContent = '授权中...';
      try {
        const tx = await odog.approve(NFT_ADDR, ethers.constants.MaxUint256);
        await tx.wait();
        updateStatus('授权成功！', 'success');
        await checkApproval();
      } catch (err) {
        console.error('[Approve Error]', err);
        updateStatus('授权失败: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = '授权 100 ODOG';
      }
    }

    async function mintNFT() {
      console.log('[Debug] 铸造按钮被点击！');
      const msg = document.getElementById('message').value.trim();
      if (!msg) return updateStatus('留言不能为空', 'error');
      if (ethers.utils.toUtf8Bytes(msg).length > 500) return updateStatus('留言超限', 'error');
      if (!confirm('确认铸造？将销毁 100 ODOG！')) return;

      const btn = document.getElementById('mint');
      btn.disabled = true;
      btn.textContent = '铸造中...';
      try {
        const tx = await nft.writeMessage(msg);
        await tx.wait();
        updateStatus(`铸造成功！Tx: ${tx.hash.slice(0,10)}...`, 'success');
        document.getElementById('message').value = '';
        btn.disabled = true;
      } catch (err) {
        console.error('[Mint Error]', err);
        updateStatus('铸造失败: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = '铸造 NFT';
      }
    }

    console.log('[Debug] 脚本加载完成');
  </script>
</body>
                                                      </html>
