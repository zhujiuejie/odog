<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Odog NFT 铸造</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --text: #c9d1d9;
      --accent: #58a6ff;
      --success: #2f855a;
      --error: #e53e3e;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 600px;
      background: var(--card);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #30363d;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    h1 {
      color: var(--accent);
      text-align: center;
      margin-bottom: 20px;
    }
    .message-input {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #30363d;
      background: transparent;
      color: var(--text);
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-direction: column;
    }
    button {
      padding: 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      color: #fff;
      transition: opacity 0.3s; /* 平滑反馈 */
    }
    .btn-connect { background: #38a169; }
    .btn-approve { background: #e3a62d; }
    .btn-mint { background: #4299e1; }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    button:active { /* 点击反馈：轻微变暗 */
      opacity: 0.8;
    }
    .warning {
      color: var(--error);
      font-size: 0.9rem;
      margin-top: 10px;
      text-align: center;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .status-info { background: #4299e140; color: var(--accent); }
    .status-success { background: #2f855a40; color: var(--success); }
    .status-error { background: #e53e3e40; color: var(--error); }
  </style>
</head>
<body>
  <div class="container">
    <h1>Odog NFT 铸造</h1>
    <textarea class="message-input" id="message-input" placeholder="输入你的留言（500 字节限制）"></textarea>
    <div class="controls">
      <button id="connect-button" class="btn-connect">连接钱包</button>
      <button id="approve-button" class="btn-approve" disabled>授权 100 ODOG</button>
      <button id="mint-button" class="btn-mint" disabled>铸造 NFT</button>
    </div>
    <div class="warning">⚠️ 注意：铸造 NFT 将永久销毁 100 ODOG！操作不可逆，请谨慎。</div>
    <div id="status" class="status status-info">准备就绪，请连接钱包开始。</div>
  </div>

  <script>
    // 配置（不变）
    const NFT_CONTRACT_ADDRESS = "0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917";
    const ODOG_TOKEN_ADDRESS = "0xc3f431cd1b7220cca703ee08c24ca645a71e72c8";
    const CHAIN_ID_DECIMAL = 196;
    const CHAIN_ID_HEX = ethers.utils.hexValue(CHAIN_ID_DECIMAL);
    const ODOG_AMOUNT = ethers.utils.parseUnits("100", 18);

    const ERC20_ABI = [ /* ... ABI 不变，省略以节省空间 ... */ ]; // 用上次的 ABI
    const NFT_CONTRACT_ABI = [ /* ... ABI 不变 ... */ ];

    let provider = null;
    let signer = null;
    let nftContract = null;
    let odogContract = null;
    let currentAccount = null;

    function setStatus(msg, type = 'info') {
      const statusDiv = document.getElementById('status');
      if (statusDiv) {
        statusDiv.textContent = msg;
        statusDiv.className = `status status-${type}`;
      }
      console.log('[Status]', msg); // 调试日志
    }

    // 绑定事件的核心函数
    function bindEvents() {
      const connectButton = document.getElementById('connect-button');
      const approveButton = document.getElementById('approve-button');
      const mintButton = document.getElementById('mint-button');

      if (!connectButton) {
        console.error('[Error] 找不到连接按钮！页面加载问题？');
        return;
      }

      // 连接钱包
      connectButton.addEventListener('click', async function() {
        console.log('[Debug] 连接按钮被点击了！'); // 确认点击响应
        connectButton.disabled = true;
        connectButton.textContent = '连接中...';
        try {
          if (typeof window.ethereum === 'undefined') {
            setStatus('未检测到钱包插件，请安装 MetaMask 或 OKX Wallet。', 'error');
            throw new Error('No wallet');
          }
          provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
          signer = provider.getSigner();
          setStatus('请求连接钱包，请在钱包中确认...', 'info');
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          if (!accounts || accounts.length === 0) {
            setStatus('未获取到账户，请在钱包中解锁并授权。', 'error');
            throw new Error('No accounts');
          }
          currentAccount = accounts[0];
          setStatus(`钱包连接成功：${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`, 'success');
          connectButton.textContent = '已连接';

          // 初始化合约
          nftContract = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer);
          odogContract = new ethers.Contract(ODOG_TOKEN_ADDRESS, ERC20_ABI, signer);

          // 检查网络和授权
          const net = await provider.getNetwork();
          if (net.chainId !== CHAIN_ID_DECIMAL) {
            setStatus(`请切换到 X Layer 网络 (Chain ID ${CHAIN_ID_DECIMAL})`, 'error');
            return;
          }
          await checkAllowance();
        } catch (e) {
          console.error('[Connect Error]', e);
          setStatus('连接失败：' + (e.message || '请检查钱包设置'), 'error');
          connectButton.disabled = false;
          connectButton.textContent = '连接钱包';
        }
      });

      // 其他事件绑定类似，省略 approve 和 mint 以节省空间，用上次的逻辑
      // ... (approveButton.addEventListener 和 mintButton.addEventListener，用之前代码)
    }

    // 等待页面完全加载后再绑定事件（关键修复！）
    window.addEventListener('load', function() {
      console.log('[Debug] 页面加载完成，开始绑定事件');
      bindEvents();
    });

    // 如果页面已加载，直接绑定
    if (document.readyState === 'complete') {
      bindEvents();
    }
  </script>
</body>
</html>
