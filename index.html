<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odog 留言墙 NFT 铸造</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        /* 深色主题和排版样式 */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a202c; /* 柔和的深蓝灰色 */
            color: #e2e8f0; /* 浅灰色文字 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            background-color: #2d3748; /* 稍亮的深蓝灰色，模拟卡片 */
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 100%;
            transition: all 0.3s ease;
        }
        h1 {
            color: #4299e1; /* 品牌蓝色 */
            text-align: center;
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #4a5568;
            border-radius: 8px;
            background-color: #232d39; /* 输入区域更深 */
            color: #e2e8f0;
            resize: none;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        textarea:focus {
            outline: none;
            border-color: #4299e1;
        }
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background-color: #4299e1;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #3182ce;
        }
        button:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
            opacity: 0.6;
        }
        #status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #38a1691a; /* 成功绿色透明 */
            color: #48bb78;
            text-align: center;
            word-break: break-all;
            display: none;
        }
        #wallet-info {
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.9em;
            color: #cbd5e0;
        }
        .error {
            background-color: #e53e3e1a !important; /* 错误红色透明 */
            color: #fc8181 !important;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Odog 链上留言墙</h1>
    <div id="wallet-info">请连接钱包并切换到 **Chain ID 196** (或您的网络)</div>
    
    <textarea id="message-input" placeholder="输入你想永久记录在区块链上的留言... (500字节限制)"></textarea>
    
    <button id="mint-button" onclick="mintMessage()" disabled>连接钱包并铸造 (100 ODOG)</button>
    
    <div id="status-message"></div>
</div>

<script>
    // =================================================================
    // 1. 配置信息 (请勿更改，除非合约地址或 Chain ID 更改)
    // =================================================================
    const CONTRACT_ADDRESS = "0x8ed8ed9f316016fcE26722A84B214ADE7E3c7917";
    const CHAIN_ID_DECIMAL = 196; // 您的区块链 ID
    
    // ODOG 代币支付的金额 (100 ODOG, 假设 18 位小数)
    const ODOG_AMOUNT = ethers.utils.parseUnits("100", 18); 

    // =================================================================
    // 2. 合约 ABI (!!! 必须替换为您的真实 ABI !!!)
    // =================================================================
    // 请在这里粘贴您的 OdogMessageWall 合约的 ABI JSON 数组内容
    const CONTRACT_ABI = 
    [[{"constant":false,"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"constant":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","payable":false,"type":"event"},{"constant":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","payable":false,"type":"event"},{"constant":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","payable":false,"type":"event"},{"constant":false,"inputs":[],"name":"ODOG_TOKEN","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getMessage","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":false,"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"string","name":"message","type":"string"}],"name":"writeMessage","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}]
    ]; 

    // =================================================================
    // 3. Ethers.js 核心逻辑
    // =================================================================

    const statusDiv = document.getElementById('status-message');
    const mintButton = document.getElementById('mint-button');
    const walletInfoDiv = document.getElementById('wallet-info');
    let provider;
    let signer;
    let contract;
    let currentAccount = null;

    /**
     * 显示状态消息
     * @param {string} message - 消息内容
     * @param {boolean} isError - 是否为错误消息
     */
    function setStatus(message, isError = false) {
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        statusDiv.className = isError ? 'error' : '';
    }

    /**
     * 检查钱包连接和网络状态
     */
    async function checkWalletConnection() {
        if (typeof window.ethereum === 'undefined') {
            walletInfoDiv.textContent = "请安装 MetaMask 或其他 Web3 钱包。";
            mintButton.disabled = true;
            return;
        }

        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            
            // 请求账户连接
            const accounts = await provider.send("eth_accounts", []);
            
            // 首次连接时，需要用户手动触发 connect (例如点击按钮)
            if (accounts.length === 0) {
                 walletInfoDiv.textContent = "请点击铸造按钮连接钱包。";
                 mintButton.disabled = false;
                 mintButton.onclick = connectWallet; // 第一次点击用于连接
                 return;
            }
            
            currentAccount = accounts[0];
            const { chainId } = await provider.getNetwork();

            walletInfoDiv.innerHTML = `账户: <strong>${currentAccount.substring(0, 6)}...${currentAccount.substring(38)}</strong> | 链ID: <strong>${chainId}</strong>`;

            if (chainId !== CHAIN_ID_DECIMAL) {
                setStatus(`⚠️ 网络错误！请切换到 Chain ID ${CHAIN_ID_DECIMAL} 的网络进行铸造。`, true);
                mintButton.disabled = true;
                return;
            }
            
            // 网络和账户都正确
            signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            mintButton.textContent = "点击铸造 (100 ODOG)";
            mintButton.disabled = false;
            mintButton.onclick = mintMessage; // 恢复点击事件为铸造
            setStatus("", false);

        } catch (error) {
            console.error("连接钱包或检查网络状态失败:", error);
            setStatus("连接钱包失败，请确保钱包已解锁并刷新页面。", true);
            mintButton.disabled = true;
        }
    }

    /**
     * 连接钱包（用于首次点击）
     */
    async function connectWallet() {
        try {
            await provider.send("eth_requestAccounts", []);
            await checkWalletConnection(); // 连接成功后再次检查
        } catch (error) {
             setStatus("钱包连接被拒绝。", true);
        }
    }

    /**
     * 铸造消息 NFT
     */
    async function mintMessage() {
        if (!signer || !contract) {
            setStatus("请先连接钱包并切换到正确的网络。", true);
            return;
        }

        const message = document.getElementById('message-input').value.trim();
        const messageBytes = ethers.utils.toUtf8Bytes(message);

        if (messageBytes.length === 0) {
            setStatus("留言内容不能为空。", true);
            return;
        }
        if (messageBytes.length > 500) {
            setStatus(`留言内容 (${messageBytes.length} 字节) 超过 500 字节限制。`, true);
            return;
        }

        mintButton.disabled = true;
        mintButton.textContent = "正在发起交易... (请检查钱包)";
        setStatus("请在您的钱包中授权 **100 ODOG** 代币给合约，然后确认交易...", false);

        try {
            // 步骤 1: 确保用户已授权 ODOG 代币给本合约
            // 您的合约使用 transferFrom，所以用户需要提前对合约进行授权。
            // 网站无法直接帮你授权，但可以提醒。

            // 步骤 2: 调用 writeMessage
            const tx = await contract.writeMessage(message);
            
            mintButton.textContent = "交易发送成功，等待确认...";
            setStatus(`交易已发送: ${tx.hash}. 请等待区块链确认...`, false);

            // 等待交易被打包确认
            const receipt = await tx.wait(); 

            setStatus(`✅ 铸造成功！交易哈希: ${receipt.transactionHash}. 请在区块链浏览器中查看您的 NFT。`, false);
            document.getElementById('message-input').value = ''; // 清空输入框

        } catch (error) {
            console.error(error);
            // 尝试解析 MetaMask 或 EVM 错误消息
            let errorMessage = "铸造失败！请检查错误详情。";
            if (error.code === 4001) {
                errorMessage = "交易被用户拒绝。";
            } else if (error.message && error.message.includes("Transfer failed")) {
                errorMessage = "铸造失败：请确认您已对合约授权足够的 ODOG 代币，且账户余额充足！";
            } else if (error.message) {
                 // 尝试提取 RPC 错误信息
                 const match = error.message.match(/\[ethjs-query\]\s*(\w+)/);
                 if (match) {
                    errorMessage = `铸造失败：${match[1]}`;
                 }
            }
            
            setStatus(errorMessage, true);
        } finally {
            mintButton.disabled = false;
            mintButton.textContent = "点击铸造 (100 ODOG)";
        }
    }

    // 监听钱包账户或网络切换
    if (typeof window.ethereum !== 'undefined') {
        window.ethereum.on('chainChanged', () => {
            window.location.reload();
        });
        window.ethereum.on('accountsChanged', () => {
            window.location.reload();
        });
    }

    // 页面加载完成后立即检查连接状态
    window.onload = checkWalletConnection;

</script>
</body>
</html>
